(function(){var mt=Object.defineProperty;var ut=(n,e,t)=>e in n?mt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>(ut(n,typeof e!="symbol"?e+"":e,t),t),Se=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var u=(n,e,t)=>(Se(n,e,"read from private field"),t?t.call(n):e.get(n)),E=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},T=(n,e,t,i)=>(Se(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t);var C=(n,e,t)=>(Se(n,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class de{constructor(e){this.subscribers=e}changeSubscribers(e){this.subscribers=e}notify(){this.subscribers.forEach(e=>e.receive())}}class A{constructor(e,t="compassSpotTemplateFrame"){a(this,"frameElement");a(this,"windowObject",window);a(this,"onClose");var r,o;this.encryptedSpotId=e,this.id=t;const i=document.getElementById(t),s=document.getElementById(e);i!=null&&(i==null?void 0:i.nodeName)==="IFRAME"?this.frameElement=i:(this.frameElement=this.createTemplateFrameElement(),s.appendChild(this.frameElement)),this.onClose=(o=(r=this.windowObject.microadCompass)==null?void 0:r.overridingHandler)==null?void 0:o.onClose}getFrameElement(){return this.frameElement}selectElement(e){return this.getContentDocument().getElementById(e)}selectWindow(){return this.frameElement.contentWindow}createTemplateFrameElement(){const e=document.createElement("iframe");return e.id=this.id,e.setAttribute("allowFullScreen","true"),e.setAttribute("allowTransparency","true"),e.setAttribute("border",""),e.style.border="0",e}writeContents(e){this.getContentDocument().open();const t=`${e.html||""}${e.css||""}${e.js||""}`;this.getContentDocument().write(`<html><head></head><body>${t}</body></html>`),this.getContentDocument().close(),this.getContentDocument().body.style.margin="0"}hideFrameElement(){this.updateStyles({display:"none"}),this.onClose!=null&&this.onClose()}updateStyles(e){Object.entries(e).forEach(([t,i])=>{t in this.frameElement.style&&(this.frameElement.style[t]=i)})}deleteAllBodyChildrenElements(){const{body:e}=this.getContentDocument();for(;e.firstChild!=null;)e.removeChild(e.firstChild)}activeScroll(){this.getContentDocument().body.removeEventListener("touchmove",this.preventDefault),this.getContentDocument().body.removeEventListener("wheel",this.preventDefault)}inactiveScroll(){this.getContentDocument().body.addEventListener("touchmove",this.preventDefault,{passive:!1}),this.getContentDocument().body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(e){e==null||e.preventDefault()}getContentDocument(){let e;for(;(e=this.frameElement.contentDocument)==null;);return e}replaceText(e,t){const i=this.getContentDocument().getElementById(e);i!=null&&(i.innerText=t)}removeFrameElement(){this.frameElement.remove()}}class qe{constructor(e){a(this,"templateFrameRepository");this.encryptedSpotId=e,this.templateFrameRepository=new A(e)}receive(){this.templateFrameRepository.hideFrameElement(),this.templateFrameRepository.activeScroll()}}class Xe{executeRequest(e){const t="https://s-rtb.send.microad.jp/ad",i=e?`${t}?${e}`:t;this.sendRequestByJSONP(i)}sendRequestByJSONP(e){var s;const t=document.getElementsByTagName("script")[0],i=document.createElement("script");return i.type="text/javascript",i.defer=!0,i.src=e,(s=t.parentNode)==null||s.insertBefore(i,t),i}}class pt{constructor(e,t,i){a(this,"adRequestRepository");a(this,"templateFrameRepository");this.adRequest=e,this.adResponse=t,this.selectedAudienceIds=i,this.adRequestRepository=new Xe,this.templateFrameRepository=new A(t.getEncryptedSpotId())}receive(){const e=this.adResponse.getRotationMax(),t=this.adResponse.getSequence();if(e==null||t==null)throw new Error("[COMPASS-JS] Cant read rotation_max or sequence. therefore, next advertisement is not display.");if(!this.adResponse.isExecutableRotation()){this.templateFrameRepository.hideFrameElement();return}if(this.adRequest.getEncryptedSpotId()==null)return;const i=this.adResponse.createRotationParams();this.adRequestRepository.executeRequest(this.adRequest.createRequestURL(i,void 0,this.selectedAudienceIds))}}class L{getStyle(e,t){return e.style[t]}observeSize(e,t){new ResizeObserver(()=>{e.style.width=`${t.offsetWidth}px`,e.style.height=`${t.offsetHeight}px`}).observe(t)}appendSameElement(e,t,i){Object.keys([...Array(i)]).forEach(()=>{e.appendChild(document.createElement(t))})}addCssClass(e,t){e.className=t}clickBy(e){const t=this.getClickEventTargetElement(e);if(t==null)return;t.click()}updateStyles(e,t){e!=null&&Object.entries(t).forEach(([i,s])=>{i in e.style&&e.style[i]!=null&&(e.style[i]=s)})}activeMovePageHistoryEvent(e,t,i){e.history.replaceState(null,"",null),e.addEventListener("pagehide",i),e.addEventListener("pageshow",t)}inactiveMovePageHistoryEvent(e,t,i){i&&e.removeEventListener("pagehide",i),t&&e.removeEventListener("pageshow",t)}activeVisibilityChangeEvent(e,t){e.document.addEventListener("visibilitychange",t)}inactiveVisibilityChangeEvent(e,t){e.document.removeEventListener("visibilitychange",t)}activeHashChangeEvent(e,t){e.addEventListener("hashchange",t)}inactiveHashChangeEvent(e,t){e.removeEventListener("hashchange",t)}activePopstateEvent(e,t){e.addEventListener("popstate",t)}inactivePopstateEvent(e,t){e.removeEventListener("popstate",t)}preventAnchorClick(e,t){if(e==null||t==null)return;const i=this.getClickEventTargetElement(e);e.addEventListener("click",s=>{s.preventDefault(),(i==null?void 0:i.href)!=null&&t(i.href)})}getClickEventTargetElement(e){if(["a","A"].includes(e.nodeName))return e;let t;return Array.from(e.childNodes).forEach(i=>{t==null&&(t=this.getClickEventTargetElement(i))}),t}getContentDocument(e){let t;do t=e.contentDocument;while(e.contentDocument==null);return t}findElementById(e,t){return e.getElementById(t)}}class De{constructor(e,t,i,s){a(this,"templateRepository");a(this,"templateFrameRepository");a(this,"template");if(this.maybeTemplate=e,this.encryptedSpotId=t,this.styleItems=i,this.isOverlay=s,e==null||!Object.values(e).length)throw new Error("[COMPASS-JS] Cant read spot template. therefore, advertisement is not display.");this.template=e,this.templateRepository=new L,this.templateFrameRepository=new A(t)}rendering(){this.templateFrameRepository.writeContents(this.template),this.templateFrameRepository.updateStyles(this.styleItems),this.templateFrameRepository.inactiveScroll(),this.isOverlay||this.observeSpotTemplateSize()}observeSpotTemplateSize(e="compassSpotTemplate"){const t=this.templateFrameRepository.getFrameElement(),i=this.templateFrameRepository.selectElement(e);if(t==null||i==null)throw new Error("[COMPASS-JS] Cant find either spot temprate or iframe");this.templateRepository.observeSize(t,i)}}const Ne={position:"fixed",zIndex:"2147483647",top:"0",left:"0",width:"100%",height:"100%"};class Le{constructor(e,t=new A(e)){a(this,"tagName","");this.encryptedSpotId=e,this.templateFrameRepository=t}createElement(e,t){const i=document.createElement(this.tagName);return i.id=e,i.setAttribute("allowFullScreen","true"),i.setAttribute("allowTransparency","true"),i.setAttribute("border",""),i.style.border="0",t!=null&&t.width&&(i.style.width=`${t.width}px`),t!=null&&t.height&&(i.style.height=`${t.height}px`),i}append(e,t){e.appendChild(t)}removeAll(e){for(;e.firstChild!=null;)e.removeChild(e.firstChild)}inactiveClickOrTouch(e){e.style.pointerEvents="none"}writeAdToChildElement(e,t){const i=s=>document.createRange().createContextualFragment(s);e.html&&t.appendChild(i(e.html)),e.css&&t.appendChild(i(e.css)),e.js&&t.appendChild(i(e.js))}connectResizeObserver(e,t){new ResizeObserver(()=>{e.style.width=`${t.offsetWidth}px`,e.style.height=`${t.offsetHeight}px`}).observe(t)}}class We extends Le{constructor(){super(...arguments);a(this,"isNecessaryWrapper",!0);a(this,"tagName","iframe")}write(t,i,s){const r=this.getContentDocument(s);r.open();const o=i!=null?`${i.width}px`:"fit-content",c=i!=null?`${i.height}px`:"fit-content",l=`<body style="margin: 0; width: ${o}; height: ${c}; overflow: hidden;">`,d=`${t.html||""}${t.css||""}${t.js||""}`;return r.write(`<html><head></head>${l}${d}</body></html>`),r.close(),i&&(r.body.style.minWidth="200px"),this.inactiveScroll(r),s.contentWindow}observeSize(t){const i=this.getContentDocument(t);super.connectResizeObserver(t,i.body)}append(t,i){t.style.lineHeight="0",super.append(t,i)}getContentDocument(t){let i;do i=t.contentDocument;while(t.ownerDocument==null);return i}inactiveScroll(t){t.body.addEventListener("touchmove",this.preventDefault,{passive:!1}),t.body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(t){t==null||t.preventDefault()}}class yt extends Le{constructor(t){super(t);a(this,"isNecessaryWrapper",!0);a(this,"tagName","div");this.encryptedSpotId=t}write(t,i){const s=this.templateFrameRepository.getContentDocument().getElementById("compassSpotTemplateAdWrapper");if(s==null)return;const r=i!=null?`${i.width}px`:"fit-content",o=i!=null?`${i.height}px`:"fit-content";return s.style.width=r,s.style.height=o,s.style.margin="0",s.style.overflow="hidden",this.writeAdToChildElement(t,s),i&&(s.style.minWidth="200px"),s.ownerDocument.defaultView}observeSize(t){const i=this.templateFrameRepository.getContentDocument().getElementById("compassSpotTemplateAdWrapper");i!=null&&this.connectResizeObserver(t,i)}}class gt extends Le{constructor(t){super(t);a(this,"isNecessaryWrapper",!1);this.encryptedSpotId=t}getMainElement(){const t=this.templateFrameRepository.getContentDocument().getElementById("compassSpotTemplateMain");if(t==null)throw Error("a");return t.setAttribute("allowFullScreen","true"),t.setAttribute("allowTransparency","true"),t.setAttribute("border",""),t.style.border="0",t}write(t,i){const s=this.templateFrameRepository.getContentDocument().getElementById("compassSpotTemplateMain");if(s!=null)return s.style.margin="0",s.style.overflow="hidden",this.writeAdToChildElement(t,s),i&&(s.style.minWidth="200px"),s.ownerDocument.defaultView}}const $=class ${constructor(){try{$.consoleLog=e=>{e!=null&&console.log(e)}}catch{$.consoleLog=()=>{}}}static log(e){$.isDebugMode()&&$.consoleLog(`【DEBUG】${e}`)}static isDebugMode(){return"false".trim().toLowerCase()==="true"}};a($,"consoleLog");let y=$;new y;class ce{get eventKey(){return Symbol(this.eventName)}}class ft extends ce{constructor(){super(...arguments);a(this,"eventName","viewableImpression")}createDetail(t){return{spot:t}}}const Re={noAdAvailable:{errorCode:1,msg:"Rewarded ads will not be displayed due to non-display conditions."},noAdObtained:{errorCode:2,msg:"No ad obtained to place a reward ad."},unexpectedError:{errorCode:3,msg:"An unexpected error has occurred."}};class vt extends ce{constructor(){super(...arguments);a(this,"eventName","noAd")}createDetail(t,i){return{spot:t,errorCode:Re[i].errorCode,msg:Re[i].msg}}}class Et extends ce{constructor(){super(...arguments);a(this,"eventName","rewardAdClosed")}createDetail(t,i){return{spot:t,isRewarded:i}}}class wt extends ce{constructor(){super(...arguments);a(this,"eventName","rewardAdEnded")}createDetail(t){return{spot:t}}}class Ct extends ce{constructor(){super(...arguments);a(this,"eventName","rewardAdGranted")}createDetail(t){return{spot:t}}}class At extends ce{constructor(){super(...arguments);a(this,"eventName","rewardAdReady")}createDetail(t){return{spot:t}}}const w={viewableImpression:"viewableImpression",noAd:"noAd",rewardAdClosed:"rewardAdClosed",rewardAdEnded:"rewardAdEnded",rewardAdGranted:"rewardAdGranted",rewardAdReady:"rewardAdReady"};var K,G,J,fe,Ye,D,P,ve,Qe,Ee,Ze,N,U;class St{constructor(){E(this,fe);E(this,D);E(this,ve);E(this,Ee);E(this,N);E(this,K,new EventTarget);E(this,G,!1);E(this,J,new Map);C(this,fe,Ye).call(this),u(this,K).addEventListener("rewardAdGranted",()=>{T(this,G,!0)},{once:!0})}notifyViewableImpression(e){C(this,N,U).call(this,w.viewableImpression,e),y.log(`viewableImpressionイベントが発火しました。(広告枠ID：${e})`)}notifyNoAd(e,t){C(this,N,U).call(this,w.noAd,e,t),y.log(`noAdイベントが発火しました。(エラーコード：${Re[t].errorCode}, 広告枠ID：${e})`)}notifyAdClosed(e){C(this,N,U).call(this,w.rewardAdClosed,e,u(this,G)),y.log(`rewardAdClosedイベントが発火しました。(報酬獲得状態：${u(this,G)}, 広告枠ID：${e})`)}notifyAdEnded(e){C(this,N,U).call(this,w.rewardAdEnded,e),y.log(`rewardAdEndedイベントが発火しました。(広告枠ID：${e})`)}notifyAdGranted(e){C(this,N,U).call(this,w.rewardAdGranted,e),y.log(`rewardAdGrantedイベントが発火しました。(広告枠ID：${e})`)}notifyAdReady(e){C(this,N,U).call(this,w.rewardAdReady,e),y.log(`rewardAdReadyイベントが発火しました。(広告枠ID：${e})`)}setListeners(e,t=!0){Object.entries(e).forEach(([i,s])=>{const r=w[i];C(this,ve,Qe).call(this,r,s,t)})}}K=new WeakMap,G=new WeakMap,J=new WeakMap,fe=new WeakSet,Ye=function(){C(this,D,P).call(this,new vt),C(this,D,P).call(this,new ft),C(this,D,P).call(this,new Et),C(this,D,P).call(this,new wt),C(this,D,P).call(this,new Ct),C(this,D,P).call(this,new At)},D=new WeakSet,P=function(e){u(this,J).set(e.eventName,e)},ve=new WeakSet,Qe=function(e,t,i){if(!u(this,J).get(e)){i&&y.log(`${e} が未定義のため、イベントリスナーへ追加は行いませんでした。`);return}u(this,K).addEventListener(e,t),i&&y.log(`${e} にイベントリスナーを追加しました。`)},Ee=new WeakSet,Ze=function(e,t){e.description&&u(this,K).dispatchEvent(new CustomEvent(e.description,{detail:t}))},N=new WeakSet,U=function(e,...t){const i=u(this,J).get(e);if(i){const s=i.createDetail(...t);C(this,Ee,Ze).call(this,i.eventKey,s)}};const v=new St;class O{static setup(e,t,i){if(O.isAlreadyProxied(e))return;const s=O.createMainHandler(t,i),r=new Proxy({},s);r.__isProxy=!0,e.__ma_compass_video_ad_player=r}static isAlreadyProxied(e){var t;return((t=e.__ma_compass_video_ad_player)==null?void 0:t.__isProxy)||!1}static createMainHandler(e,t){return{set(i,s,r){return O.handleDirectEventHookAPI(i,s,e,t),r=O.proxyNestedIfNeeded(r,s,e,t),r&&(i[s]=r),O.handleKeySetEventHookAPI(s,r,e,t),!0}}}static handleDirectEventHookAPI(e,t,i,s){const r=Number(t);t==="eventHookAPI"&&!Number.isNaN(r)&&e[r]&&typeof e[r]=="object"&&e[r].__proxyKey===i&&v.notifyAdEnded(s)}static proxyNestedIfNeeded(e,t,i,s){if(typeof e=="object"&&e!=null&&t!=="eventHookAPI"&&e&&!e.__isEventHookAPIProxy){const r=O.createNestedHandler(t,i,s);e=new Proxy(e,r),e&&(e.__isEventHookAPIProxy=!0,e.__proxyKey=t)}return e}static createNestedHandler(e,t,i){return{set(s,r,o){return s[r]=o,r==="eventHookAPI"&&String(e)===String(t)&&o&&(o.completed=()=>{v.notifyAdEnded(i)}),!0}}}static handleKeySetEventHookAPI(e,t,i,s){e===i&&t&&t.eventHookAPI&&v.notifyAdEnded(s)}}class Tt{constructor(e,t,i){a(this,"templateIframeRepository");a(this,"templateDivRepository");a(this,"templateNoneRepository");a(this,"templateFrameRepository");a(this,"rendering",(e,t,i)=>{if(t==null)return;const s=this.templateFrameRepository.selectElement(this.id);if(s!=null)switch(e){case"iframe":this.updateWrapper(this.templateIframeRepository,"compassSpotTemplateAdWrapper",s,i,t);break;case"div":this.updateWrapper(this.templateDivRepository,"compassSpotTemplateAdWrapper",s,i,t);break;case"none":this.updateWrapper(this.templateNoneRepository,"",s,i,t);break}});this.encryptedSpotId=e,this.impressionId=t,this.id=i,this.templateIframeRepository=new We(e),this.templateDivRepository=new yt(e),this.templateNoneRepository=new gt(e),this.templateFrameRepository=new A(e)}updateWrapper(e,t,i,s,r){e.removeAll(i);const o=e.isNecessaryWrapper?e.createElement(t,s):e.getMainElement();e.isNecessaryWrapper&&e.append(i,o);const c=e instanceof We?e.write(r,s,o):e.write(r,s);c&&O.setup(c,this.impressionId,this.encryptedSpotId),e.isNecessaryWrapper&&s==null&&e.observeSize(o),this.templateFrameRepository.selectElement("compassSpotTemplateAcceptButton")!=null&&e.inactiveClickOrTouch(i)}}class It{constructor(e,t){a(this,"templateRepository");a(this,"templateFrameRepository");this.id=e,this.adResponse=t,this.templateRepository=new L,this.templateFrameRepository=new A(t.getEncryptedSpotId())}changeStorage(e){this.adResponse=e}rendering(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getRotationMax();t!=null&&(this.templateRepository.appendSameElement(e,"div",t+1),this.receive())}receive(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getSequence()?Number(this.adResponse.getSequence())-2:0;Array.from(e.children).forEach((i,s)=>{const r=`compassSpotTemplateRotation${t===s?"CurrentButton":"Button"}`;this.templateRepository.addCssClass(i,r)})}}class Te{constructor(e,t){this.beacon=e,this.parentElement=t}fire(){const e=this.createBeaconWrapperElement();this.parentElement.appendChild(e),e.append(...this.beacon)}createBeaconWrapperElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.visibility="hidden",e}}class Oe{constructor(e){this.beacon=e}create(){switch(typeof this.beacon){case"string":return new Te(this.convertFromString(this.beacon),document.body);default:return}}createByURL(){if(typeof this.beacon=="string"){const e=this.createImgBeacon(this.beacon);return new Te(e?[e]:[],document.body)}if(Array.isArray(this.beacon)){const e=this.beacon.map(t=>this.createImgBeacon(t)).filter(t=>t!=null);return new Te(e,document.body)}}convertFromString(e){const i=new DOMParser().parseFromString(e,"text/html");return i.documentElement.nodeName==="parsererror"?[]:Array.from(i.body.childNodes)}createImgBeacon(e){const t=document.createElement("img");return t.width=0,t.height=0,t.style.width="0px",t.style.height="0px",t.style.display="none",t.src=e,t}}class _e{constructor(e,t,i,s,r,o,c){a(this,"maybeBeaconRepository");this.maybeMicroadCompassFrequency=t,this.adRequest=i,this.adTag=s,this.frequencyParams=r,this.targetElementId=o,this.isFirstViewing=c,this.maybeBeaconRepository=new Oe(e).create()}receive(){var e,t;this.adRequest!=null&&this.isFirstViewing&&((e=this.maybeMicroadCompassFrequency)==null||e.callRewardAcquisitionProcess(this.adRequest,this.adTag,this.frequencyParams,this.targetElementId)),(t=this.maybeBeaconRepository)==null||t.fire()}}class Be{hideTemplate(e){new qe(e).receive()}}class bt{constructor(e,t){a(this,"templateRepository");a(this,"templateFrameRepository");this.id=t,this.templateRepository=new L,this.templateFrameRepository=new A(e)}receive(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.templateFrameRepository.selectElement("compassSpotTemplateAdWrapper");this.isHTMLIFrameElement(t)&&t.contentDocument?this.templateRepository.clickBy(t.contentDocument.body):this.templateRepository.clickBy(e)}isHTMLIFrameElement(e){return e!=null&&"contentDocument"in e}}class Rt{constructor(e){a(this,"ITUNES_REGEX",/https?:\/\/itunes\.apple\.com/);this.value=e}isTransitionByBlank(){return!(this.ITUNES_REGEX.test(this.value)||this.ITUNES_REGEX.test(decodeURIComponent(this.value)))}}class kt{constructor(e,t=[]){a(this,"beaconRepositoryFactory");this.url=e,this.beaconRepositoryFactory=new Oe(t)}receive(){var e;this.transitionToUrl(),(e=this.beaconRepositoryFactory.createByURL())==null||e.fire()}transitionToUrl(){if(new Rt(this.url).isTransitionByBlank())window.open(this.url);else if(window.top!=null)window.top.location.href=this.url;else throw new Error("[COMPASS-JS] Cant find window top. therefore, cant transition to url.")}}class et{constructor(e,t,i=new L){this.templateFrameRepository=e,this.onRedirect=t,this.templateRepository=i}addListener(e="compassSpotTemplateDescription"){this.templateRepository.preventAnchorClick(this.templateFrameRepository.selectElement(e),this.onRedirect)}clickAgree(){if(this.onRedirect==null)return;const e=this.templateRepository.findElementById(document,"compassSpotTemplateMain");if(e==null)return;const t=this.templateRepository.getContentDocument(e),i=this.templateRepository.getClickEventTargetElement(t.body);i!=null&&this.onRedirect(i.href)}}class Mt{constructor(e,t,i){this.url=e,this.onRedirect=t,this.adResponse=i}receive(){this.onRedirect==null||this.url==null?new et(new A(this.adResponse.getEncryptedSpotId()),this.onRedirect).clickAgree():this.onRedirect(this.url)}}class Ft{constructor(e,t){this.id=e,this.microadCompass=t}create(e){const t=e.getLandingPageUrl(),i=e.getClickTrackingUrls()||[],s=this.microadCompass.selectMicroadCompassOverridingHandler();return(s==null?void 0:s.onRedirect)!=null?new Mt(t,s.onRedirect,e):t?new kt(t,i):new bt(e.getEncryptedSpotId(),this.id)}}class xt{constructor(e=document.createElement("div"),t=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div"),d=new L){this.modalWrapperElement=e,this.guardWallElement=t,this.modalElement=i,this.titleElement=s,this.messageElement=r,this.buttonWrapperElement=o,this.cancelButtonElement=c,this.resumeButtonElement=l,this.templateRepository=d}buildModalWrapper(){return this.modalWrapperElement.id="compassModalWrapper",this.templateRepository.updateStyles(this.modalWrapperElement,{display:"none",position:"fixed",top:"0",left:"0",height:"100%",width:"100%"}),this}buildGuardWall(){return this.guardWallElement.id="compassGuardWall",this.modalWrapperElement.appendChild(this.guardWallElement),this.templateRepository.updateStyles(this.guardWallElement,{backgroundColor:"rgba(0, 0, 0, .4)",position:"absolute",display:"not-allowed",top:"0",left:"0",height:"100%",width:"100%"}),this}buildModalFrame(){return this.modalElement.id="compassModal",this.templateRepository.updateStyles(this.modalElement,{background:"rgb(255, 255, 255)",position:"absolute",height:"clamp(200px, min(50vw, 25vh), 400px)",width:"clamp(300px, min(50vw, 25vh) * 1.6, 600px)",marginLeft:"auto",marginRight:"auto",padding:"1.5rem 4%",transform:"translate(-50%, -50%)",top:"50%",left:"50%"}),this.modalWrapperElement.appendChild(this.modalElement),this}buildModalTitle(e="動画をスキップしますか？"){return this.titleElement.id="compassModalTitle",this.titleElement.innerText=e,this.templateRepository.updateStyles(this.titleElement,{fontSize:"1.3em",lineHeight:"1.3em",fontWeight:"500",margin:"0 0 1.5rem 0",textAlign:"left"}),this.modalElement.appendChild(this.titleElement),this}buildModalMessage(e="報酬を獲得できなくなります。"){return this.messageElement.id="compassModalMessage",this.messageElement.innerText=e,this.templateRepository.updateStyles(this.messageElement,{color:"rgba(0, 0, 0, .54)",lineHeight:"1.5em",marginBottom:"1.5rem",textAlign:"left"}),this.modalElement.appendChild(this.messageElement),this}buildModalButtonWrapper(){return this.buttonWrapperElement.id="compassModalButtonsWrapper",this.templateRepository.updateStyles(this.buttonWrapperElement,{display:"flex",position:"absolute",justifyContent:"flex-end",gap:"1rem",bottom:"2rem",right:"8%"}),this.modalElement.appendChild(this.buttonWrapperElement),this}buildCancelButton(e="視聴を中止"){return this.cancelButtonElement.id="compassModalCancelButton",this.cancelButtonElement.innerText=e,this.templateRepository.updateStyles(this.cancelButtonElement,{cursor:"pointer",color:"rgb(138, 180, 248)",fontWeight:"500",lineHeight:"1.5em",padding:"0.5em 1em",textAlign:"center"}),this.buttonWrapperElement.appendChild(this.cancelButtonElement),this}buildResumeButton(e="視聴を再開"){return this.resumeButtonElement.id="compassModalResumeButton",this.resumeButtonElement.innerText=e,this.templateRepository.updateStyles(this.resumeButtonElement,{borderRadius:"2px",backgroundColor:"rgb(138, 180, 248)",color:"rgb(0, 0, 0)",cursor:"pointer",fontWeight:"500",lineHeight:"1.5em",padding:"0.5em 1em",textAlign:"center"}),this.buttonWrapperElement.appendChild(this.resumeButtonElement),this}getProduct(){return this.modalWrapperElement}}class qt{constructor(e=new xt){this.builder=e}build(){return this.builder.buildModalWrapper().buildGuardWall().buildModalFrame().buildModalTitle().buildModalMessage().buildModalButtonWrapper().buildCancelButton().buildResumeButton().getProduct()}}class tt{constructor(e,t=new A(e),i=new L){this.encryptedSpotId=e,this.templateFrameRepository=t,this.templateRepository=i}writeContents(e){this.getModalContentWrapperElement()||e.appendChild(new qt().build())}getModalContentWrapperElement(){return this.templateRepository.findElementById(this.templateFrameRepository.getContentDocument(),"compassModalWrapper")}overrideCancelButtonClickEvent(e){const t=this.templateRepository.findElementById(this.templateFrameRepository.getContentDocument(),"compassModalCancelButton");t!=null&&(t.onclick=e)}overrideResumeButtonClickEvent(e){const t=this.templateRepository.findElementById(this.templateFrameRepository.getContentDocument(),"compassModalResumeButton");t!=null&&(t.onclick=e)}}class Dt{constructor(e,t,i){a(this,"templateFrameRepository");a(this,"templateRepository");a(this,"confirmModalRepository");a(this,"confirmModalContext");a(this,"videoStopIntervalId",0);this.encryptedSpotId=e,this.impressionId=t,this.frequencyValue=i,this.templateFrameRepository=new A(e),this.templateRepository=new L,this.confirmModalRepository=new tt(e),this.confirmModalContext={element:void 0,displayStyle:void 0}}setModalHTML(e){e!=null&&(this.confirmModalContext={element:e,displayStyle:this.templateRepository.getStyle(e,"display")})}removeHashChangeEvent(e,t){this.templateRepository.inactiveHashChangeEvent(e,t),e!==e.top&&this.removeHashChangeEvent(e.parent,t)}pauseTimerAtNonVideo(){this.clearPauseState(),this.frequencyValue.lockClock(),this.frequencyValue.pauseTheClock()}pauseTimerAtVideo(e){e!=null&&(this.clearPauseState(),this.frequencyValue.lockClock(),this.frequencyValue.pauseTheClock(),this.videoStopIntervalId=setInterval(()=>{e.pause()},10))}clearPauseState(){clearInterval(this.videoStopIntervalId),this.frequencyValue.unlockClock(),this.videoStopIntervalId=0}displayConfirmModal(e,t,i,s){if(i==null||s==null)return;this.templateRepository.updateStyles(this.confirmModalContext.element,{display:"block"});const r=new I().selectMicroadCompassVideoAdPlayer(this.impressionId);e==="video"?this.pauseTimerAtVideo(r):this.pauseTimerAtNonVideo();const o=()=>{y.log("確認モーダルの操作により視聴を中断します。"),this.clearPauseState(),this.frequencyValue.cancel(),this.removeHashChangeEvent(window,i),s(),v.notifyAdClosed(this.encryptedSpotId),t&&(this.templateFrameRepository.removeFrameElement(),t())};this.confirmModalRepository.overrideCancelButtonClickEvent(o.bind(this));const c=()=>{y.log("確認モーダルの操作により視聴を再開します。"),this.clearPauseState(),this.frequencyValue.startTheClock(),r&&r.autoPlay(),this.templateRepository.updateStyles(this.confirmModalContext.element,{display:"none"})};this.confirmModalRepository.overrideResumeButtonClickEvent(c.bind(this))}}const je="compass_reward";class Nt{constructor(e,t,i,s,r,o,c=void 0,l=void 0){a(this,"frequencyTimeModalOperator");a(this,"templateFrameRepository");a(this,"templateRepository");a(this,"confirmModalRepository");a(this,"closeButton");a(this,"remainingTimeText");a(this,"rewardedText");a(this,"confirmModalContext");a(this,"originalCloseButtonEvent");var d;this.encryptedSpotId=e,this.creativeType=i,this.frequencyValue=s,this.frequencyParams=r,this.isManualDisplay=o,this.hashChangeEvent=c,this.reloadAdEvent=l,this.templateFrameRepository=new A(e),this.templateRepository=new L,this.closeButton={element:void 0,displayStyle:void 0},this.remainingTimeText={element:void 0,displayStyle:void 0},this.rewardedText={element:void 0,displayStyle:void 0},this.confirmModalContext={element:void 0,displayStyle:void 0},this.confirmModalRepository=new tt(e),this.confirmModalRepository.writeContents((d=this.templateFrameRepository.selectWindow())==null?void 0:d.document.body),this.frequencyTimeModalOperator=new Dt(e,t,s)}getElementStyle(e){return e==null?{element:void 0,displayStyle:void 0}:{element:e,displayStyle:this.templateRepository.getStyle(e,"display")}}selectElements(){const e=this.templateFrameRepository.selectElement("compassSpotTemplateCloseButton");this.closeButton=this.getElementStyle(e);const t=this.templateFrameRepository.selectElement("compassSpotTemplateRemainingTimeText");this.remainingTimeText=this.getElementStyle(t);const i=this.templateFrameRepository.selectElement("compassSpotTemplateRewardedText");this.rewardedText=this.getElementStyle(i);const s=this.confirmModalRepository.getModalContentWrapperElement();return this.confirmModalContext={element:s,displayStyle:void 0},this.frequencyTimeModalOperator.setModalHTML(s),this}isExistRequiredElements(){return this.closeButton.element==null||this.remainingTimeText.element==null||this.confirmModalContext.element==null?void 0:this}hideElements(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"})}execute(){const{rewardedSec:e}=this.frequencyParams;if(e===0){this.finalizeRewardProcess();return}this.hashChangeEvent=t=>{t instanceof HashChangeEvent&&this.handleHashChangeForConfirmation(t)},this.reloadAdEvent=this.isManualDisplay?void 0:this.requestAdAgain.bind(this),this.isCompassHash(new URL(window.location.href))||(window.location.hash=je),this.addHashChangeEvent(window,this.hashChangeEvent),this.overrideWithConfirmationDialog(),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"}),this.replaceRemainingTimeMacro(this.frequencyParams.rewardedSec),this.frequencyValue.getRemainingTimeSync(this.frequencyParams.rewardedSec,this.replaceRemainingTimeMacro.bind(this),this.finalizeRewardProcess.bind(this))}isCompassHash(e){return e.hash===`#${je}`}replaceRemainingTimeMacro(e){this.templateFrameRepository.replaceText("compassSpotTemplateRemainingTime",e.toString())}finalizeRewardProcess(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:this.rewardedText.displayStyle}),this.revertCloseButtonEvent(),this.removeHashChangeEvent(window,this.hashChangeEvent),v.notifyAdGranted(this.encryptedSpotId)}overrideWithConfirmationDialog(){this.closeButton.element!=null&&(this.originalCloseButtonEvent=this.closeButton.element.onclick,this.closeButton.element.onclick=this.frequencyTimeModalOperator.displayConfirmModal.bind(this.frequencyTimeModalOperator,this.creativeType,this.reloadAdEvent,this.hashChangeEvent,this.originalCloseButtonEvent))}revertCloseButtonEvent(){this.closeButton.element!=null&&(this.closeButton.element.addEventListener("click",()=>{v.notifyAdClosed(this.encryptedSpotId)}),this.originalCloseButtonEvent?this.closeButton.element.onclick=this.originalCloseButtonEvent.bind(this):this.closeButton.element.onclick=null)}handleHashChangeForConfirmation(e){var t;this.isCompassHash(new URL(e.newURL))||((t=this.confirmModalContext.element)==null?void 0:t.style.display)!=="block"&&(this.removeHashChangeEvent(window,this.hashChangeEvent),y.log("ブラウザバックによる確認モーダル呼び出し"),this.frequencyTimeModalOperator.displayConfirmModal(this.creativeType,this.reloadAdEvent,this.hashChangeEvent,this.originalCloseButtonEvent))}requestAdAgain(){var e;this.removeHashChangeEvent(window,this.reloadAdEvent),(e=new I().getMicroadCompassAdServiceSettings())==null||e.getAdService(this.encryptedSpotId).request()}addHashChangeEvent(e,t){t!=null&&(this.templateRepository.activeHashChangeEvent(e,t),e!==e.top&&this.addHashChangeEvent(e.parent,t))}removeHashChangeEvent(e,t){t!=null&&(this.templateRepository.inactiveHashChangeEvent(e,t),e!==e.top&&this.removeHashChangeEvent(e.parent,t))}}const k=class k{selectExcludeImpressedAdsSpotIds(){return this.getCookiesFromBrowser().filter(e=>e.key===k.excludeImpressedAdsSpotidsKey).flatMap(e=>{try{const t=JSON.parse(e.value);return Array.isArray(t)?t:[]}catch{return[]}})}selectExcludeImpressedAdsAdomains(){return this.getCookiesFromBrowser().filter(e=>e.key===k.excludeImpressedAdsAdomainsKey).flatMap(e=>{try{const t=JSON.parse(e.value);return Array.isArray(t)?t.flat():[]}catch{return[]}})}registerExcludeImpressedAdsSpotIds(e){Array.isArray(e)&&e.every(i=>typeof i=="string")&&this.writeCookie(k.excludeImpressedAdsSpotidsKey,JSON.stringify(e),k.cookieExpirationSec)}registerExcludeImpressedAdsAdomains(e){this.writeCookie(k.excludeImpressedAdsAdomainsKey,JSON.stringify(e),k.cookieExpirationSec)}clearAdomains(){document.cookie=`${k.excludeImpressedAdsAdomainsKey}=; max-age=0; path=/;`}getCookiesFromBrowser(){var e;return document.cookie==null?[]:(e=document.cookie)==null?void 0:e.split(";").map(t=>{const[i,s]=t.split("=");return{key:i.trim(),value:s}})}writeCookie(e,t,i=k.cookieExpirationSec){document.cookie=`${e}=${t}; max-age=${i}; path=/;`}};a(k,"cookieExpirationSec",1209600),a(k,"excludeImpressedAdsSpotidsKey","_mafc_exclude_spotids"),a(k,"excludeImpressedAdsAdomainsKey","_mafc_exclude_adomains");let pe=k;class Ke{constructor(e,t=new pe){this.adResponse=e,this.admoainsRepository=t,this.adResponse=e}registerSpotIdsAndImpressedAdomains(e){this.admoainsRepository.registerExcludeImpressedAdsSpotIds(e),this.registerAdomains()}registerImpressedAdomains(e){this.admoainsRepository.selectExcludeImpressedAdsSpotIds().includes(e)&&this.registerAdomains()}registerAdomains(){const e=this.admoainsRepository.selectExcludeImpressedAdsAdomains(),t=this.adResponse.getAdomains(),i=t?JSON.parse(t):[],s=Array.from(new Set([...e,...i]));this.admoainsRepository.registerExcludeImpressedAdsAdomains(s)}}class Lt{activeResizeEvent(e,t){e.addEventListener("resize",t)}inactiveResizeEvent(e,t){e.removeEventListener("resize",t)}}class Ot{constructor(e,t,i=new Lt){a(this,"baseElement");a(this,"maxWidth",0);a(this,"maxHeight",0);a(this,"resizeEventListener");a(this,"getBaseElement",()=>{if(this.scalableLimitElement.offsetWidth&&this.scalableLimitElement.offsetHeight)return"itself";const{parentElement:e}=this.scalableLimitElement;return e&&e.offsetWidth&&e.offsetHeight?"parent":"window"});this.scalableLimitElement=e,this.targetWindow=t,this.eventRepository=i,this.baseElement=this.getBaseElement(),this.updateMaxSize()}startWatching(e,t){e==null||e.width===0||e.height===0||(this.resizeEventListener=this.getResizeEventListener.bind(this,e,t),this.addResizeEventListener(this.targetWindow,this.resizeEventListener))}finishWatching(){this.resizeEventListener!=null&&(this.removeResizeEventListener(this.targetWindow,this.resizeEventListener),this.resizeEventListener=null)}setStyle(e,t){if(e==null||e.width===0||e.height===0)return;const i=this.scalableLimitElement.ownerDocument.getElementById(t);if(i==null)return;const s=this.calculateScaleRatio(e);i.style.transform=`scale(${s}, ${s})`,i.style.transformOrigin=this.getTransformOriginValue(e),y.log("広告拡大処理が実行されました。")}calculateScaleRatio(e){const t=this.maxWidth/e.width,i=this.maxHeight/e.height;return Math.min(t,i)}getTransformOriginValue(e){const t=Number(this.scalableLimitElement.offsetWidth)!==e.width,i=Number(this.scalableLimitElement.offsetHeight)!==e.height;return t&&i?"top left":!t&&i?"top":t&&!i?"left":""}updateMaxSize(){switch(this.baseElement){case"itself":this.maxWidth=this.scalableLimitElement.offsetWidth,this.maxHeight=this.scalableLimitElement.offsetHeight;break;case"parent":{const{parentElement:e}=this.scalableLimitElement;this.maxWidth=(e==null?void 0:e.offsetWidth)??window.innerWidth,this.maxHeight=(e==null?void 0:e.offsetHeight)??window.innerHeight;break}default:this.maxWidth=window.innerWidth,this.maxHeight=window.innerHeight;break}}getResizeEventListener(e,t){this.updateMaxSize(),this.setStyle(e,t)}addResizeEventListener(e,t){this.eventRepository.activeResizeEvent(e,t),e!==e.top&&this.addResizeEventListener(e.parent,t)}removeResizeEventListener(e,t){this.eventRepository.inactiveResizeEvent(e,t),e!==e.top&&this.removeResizeEventListener(e.parent,t)}}const _t={of:(n,e)=>{const t=new A(n),i=t.selectElement(e),s=t.selectWindow();if(!(i==null||s==null))return new Ot(i,s)}},_={MAIN:"main",CONFIRM:"confirm"};class Bt{constructor(e,t={}){this.display=e,this.templates=t}selectDisplayFunc(){return this.display}selectTemplate(e){return this.templates[e]}registerTemplateByImpression(e,t,i){const s=this.templates[e];s!=null?this.templates[e]={...s,[t]:i}:this.templates[e]={[t]:i}}notify(e,t,i){var o;const s=(o=this.selectTemplate(e))==null?void 0:o[t];if(s==null){const c=`[COMPASS-JS] Cant find ${t} template's HTML. therefore, advertisement is not display.`;throw new Error(c)}const r=s[i];if(r==null)throw new Error("[COMPASS-JS] Cant find template's event. therefore, advertisement is not display.");r.notify()}registerSpotIdsAndImpressedAdomains(e,t){var s;((s=this.selectTemplate(e))==null?void 0:s.main).excludeImpressedAds.registerSpotIdsAndImpressedAdomains(t)}}class Pt extends Be{constructor(t,i,s,r){if(!(s!=null&&s.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();a(this,"closeClickEvent");a(this,"acceptClickEvent");a(this,"cancelClickEvent");a(this,"frame");a(this,"ad");a(this,"pager");a(this,"excludeImpressedAds");a(this,"scalingStyleDecorator");this.microadCompass=r;const o=i.isOverlay();this.frame=new De(s,i.getEncryptedSpotId(),o?Ne:{},o),this.ad=new Tt(i.getEncryptedSpotId(),i.getImpressionId(),"compassSpotTemplateMain"),this.pager=new It("compassSpotTemplateRotationContainer",i),this.excludeImpressedAds=new Ke(i);const{adRotator:c,elementHider:l,clickThroughPlayer:d}=this.generateSubscribers(t,i);this.closeClickEvent=new de([l]),this.acceptClickEvent=new de([d,c]),this.cancelClickEvent=new de([c])}rendering(t,i){var m,p,g;this.frame.rendering(),this.scalingStyleDecorator=_t.of(i.getEncryptedSpotId(),"compassSpotTemplateMain"),this.ad.rendering(i.getRenderTagType(),i.getAd(),i.getSize()),this.pager.rendering(),i.isScalable()&&((m=this.scalingStyleDecorator)==null||m.startWatching(i.getSize(),"compassSpotTemplateAdWrapper"),(p=this.scalingStyleDecorator)==null||p.setStyle(i.getSize(),"compassSpotTemplateAdWrapper"));const s=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(i.getImpressionTag(),s,t,i,!0),v.notifyViewableImpression(i.getEncryptedSpotId());const r=i.getFrequencyParams();if(r==null)return;const o=this.microadCompass.selectMicroadCompassFrequency().getCustomKeyValues(t,r.key),c=this.microadCompass.selectMicroadCompassFrequency().selectFrequency(i.getEncryptedSpotId(),o||{},r.domain);if(c==null)throw new Error("[COMPASS-JS] Cant find registered frequency. therefore, advertisement is not display.");const l=(g=this.microadCompass.getMicroadCompassAdServiceSettings())==null?void 0:g.getAdService(i.getEncryptedSpotId()),d=new Nt(i.getEncryptedSpotId(),i.getImpressionId(),i.getCreativeType(),c,r,!!(l!=null&&l.isManualDisplay));d.selectElements().isExistRequiredElements()?d.execute():d.hideElements()}reRendering(t,i,s){var m,p,g;const{adRotator:r,elementHider:o,clickThroughPlayer:c}=this.generateSubscribers(i,s);this.closeClickEvent.changeSubscribers([o]),this.acceptClickEvent.changeSubscribers([c,r]),this.cancelClickEvent.changeSubscribers([r]),this.pager.changeStorage(s),this.ad.rendering(s.getRenderTagType(),t,s.getSize()),this.pager.receive(),(m=this.scalingStyleDecorator)==null||m.finishWatching(),s.isScalable()&&((p=this.scalingStyleDecorator)==null||p.startWatching(s.getSize(),"compassSpotTemplateAdWrapper"),(g=this.scalingStyleDecorator)==null||g.setStyle(s.getSize(),"compassSpotTemplateAdWrapper"));const l=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(s.getImpressionTag(),l,i,s,!1),this.excludeImpressedAds=new Ke(s);const d=i.getEncryptedSpotId();d!=null&&t!=null&&this.excludeImpressedAds.registerImpressedAdomains(d)}generateSubscribers(t,i){const s=new pt(t,i,this.microadCompass.selectAudienceIds()),r=new qe(i.getEncryptedSpotId()),o=new Ft("compassSpotTemplateMain",this.microadCompass).create(i);return{adRotator:s,elementHider:r,clickThroughPlayer:o}}fireImpressionBeacon(t,i,s,r,o){new _e(t,i,s,r==null?void 0:r.getAd().html,r==null?void 0:r.getFrequencyParams(),"compassSpotTemplateFrame",o).receive()}}const Ut=(n,e)=>{const t=n.selectMicroadCompassOverridingHandler();(t==null?void 0:t.onAdLoaded)!=null&&t.onAdLoaded(),(t==null?void 0:t.onRedirect)!=null&&new et(new A(e.getEncryptedSpotId()),t.onRedirect).addListener()},ke={rendering:(n,e,t,i)=>{var o;const s=new Pt(e,t,t.getTemplate(_.MAIN),i);i.registerTemplateByImpression(n,_.MAIN,s);const r=(o=i.selectTemplate(n))==null?void 0:o.main;r!=null&&(r.rendering(e,t),Ut(i,t))},reRendering:(n,e,t)=>{n.reRendering(t.getAd(),e,t)}};class $t{constructor(e,t,i,s,r=new A(t.getEncryptedSpotId())){this.adRequest=e,this.adResponse=t,this.microadCompassTemplate=i,this.templateRender=s,this.templateFrameRepository=r}receive(){this.templateFrameRepository.deleteAllBodyChildrenElements(),this.templateRender(this.adResponse.getImpressionId(),this.adRequest,this.adResponse,this.microadCompassTemplate)}}class Ht extends Be{constructor(t,i,s,r){if(!(s!=null&&s.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();a(this,"acceptClickEvent");a(this,"frame");this.microadCompass=r;const o=i.isOverlay();this.frame=new De(s,i.getEncryptedSpotId(),o?Ne:{},o);const c=this.generateSubscribe(t,i);this.acceptClickEvent=new de([c])}generateSubscribe(t,i){return new $t(t,i,this.microadCompass,ke.rendering)}rendering(){this.frame.rendering()}}const it={rendering:(n,e,t,i)=>{var c,l;const s=new Ht(e,t,t.getTemplate(_.CONFIRM),i);i.registerTemplateByImpression(n,_.CONFIRM,s);const r=(c=i.selectTemplate(n))==null?void 0:c.confirm;if(r==null)return;r.rendering();const o=(l=new I().getMicroadCompassAdServiceSettings())==null?void 0:l.getAdService(t.getEncryptedSpotId());o!=null&&o.isManualDisplay||v.notifyAdReady(t.getEncryptedSpotId())}};class st{constructor(e,t,i,s,r,o,c,l,d,m,p,g,b,S,R,F,x,q,B,le,Ce,he,Ae){this.spot=e,this.callback=t,this.url=i,this.urlMacro=s,this.referrer=r,this.referrerMacro=o,this.ifa=c,this.appId=l,this.geo=d,this.vo=m,this.mimes=p,this.rtus=g,this.audiences=b,this.clientCints=S,this.cashBuster=R,this.protectedAudience=F,this.attributionReporting=x,this.version=q,this.fc=B,this.kvSet=le,this.gpid=Ce,this.adservname=he,this.adservadslot=Ae}getEncryptedSpotId(){return this.spot}buildRequestParams(e,t){return{spot:this.spot,cb:this.callback,url:this.url,url_macro:this.urlMacro,referrer:this.referrer,referrer_macro:this.referrerMacro,ifa:this.ifa,appid:this.appId,geo:this.geo,vo:this.vo,mimes:this.mimes,rtus:this.rtus,aids:[...t],ch:this.clientCints,cbt:e||this.cashBuster,pa:this.protectedAudience,ar:this.attributionReporting,ver:this.version,fc:this.fc,kv_set:this.kvSet||{},gpid:this.gpid,adservname:this.adservname,adservadslot:this.adservadslot}}createRequestURL(e,t,i){const s={spot:this.spot,cb:this.callback,url:this.url,url_macro:this.urlMacro,referrer:this.referrer,referrer_macro:this.referrerMacro,ifa:this.ifa,appid:this.appId,geo:this.geo,vo:this.vo,mimes:this.mimes,rtus:this.rtus,aids:[...i],ch:this.clientCints,cbt:t||this.cashBuster,pa:this.protectedAudience,ar:this.attributionReporting,ver:this.version,fc:this.fc,gpid:this.gpid,adservname:this.adservname,adservadslot:this.adservadslot};return Object.entries({...s,...e}).reduce((o,[c,l])=>(l instanceof(Object||Array)?Object.keys(l).length>0&&o.push(this.encodeURIParameter(c,JSON.stringify(l))):l&&o.push(this.encodeURIParameter(c,l)),o),[]).join("&")}createFrequencyCustomKeyParameters(e){if(this.kvSet==null)return{};const t=Object.entries(this.kvSet);return e.reduce((i,s)=>{var o;const r=(o=t.find(([c])=>c===s))==null?void 0:o[1];return r!=null&&(i[s]=r),i},{})}encodeURIParameter(e,t){return`${e}=${encodeURIComponent(t)}`}}class ne{of(e){return new st(e.spot,e.cb,e.url,e.url_macro,e.referrer,e.referrer_macro,e.ifa,e.appid,e.geo,e.vo,e.mimes,e.rtus,e.aids,e.ch,e.cbt,e.pa,e.ar,e.ver,e.fc,e.kv_set,e.gpid,e.adservname,e.adservadslot)}}const M=class M{static convertDomain(e,t=new URL(document.URL)){if(e==="")throw new Error("[COMPASS-JS] Invalid domain. therefore, advertisement is not display.");const i=e.replace("{","").replace("}","");if(i==="FQDN")return t.host;const s=Number(i);return Number.isInteger(s)?M.createTopLevelDomainPlusAny(s):e}static createTopLevelDomainPlusAny(e,t=new URL(document.URL).hostname){if(e<1)throw new Error("[COMPASS-JS] Number of domain pattern is less than 1. therefore, advertisement is not display.");const i=M.createTopLevelDomainPlusOne(t);if(e===1)return i;const s=t.replace(i,"").split(".").slice(-e).join(".");return s?`${s}${i}`:i}static createTopLevelDomainPlusOne(e=new URL(document.URL).hostname){const t=e.split(".");for(let i=2;i<=t.length;i+=1){const s=t.slice(-i).join(".");if(document.cookie=this.createCookie(s),M.isExist(M.testCookieName))return document.cookie=this.createCookie(s,0),s}return e}static createCookie(e,t=M.testExpireSeconds){return`${`${M.testCookieName}=${M.testValue}`}; domain=${e}; path=/; max-age=${t}`}static isExist(e){return document.cookie.split(";").map(t=>{const[i,s]=t.split("=");return{key:i.trim(),value:s}}).some(t=>t.key===e)}};a(M,"testCookieName","mtcn"),a(M,"testValue","mtcnv"),a(M,"testExpireSeconds",10);let oe=M;class Pe{constructor(e,t,i,s,r,o,c,l,d,m,p,g,b,S,R,F,x){this.impressionId=e,this.impressionUrls=t,this.encryptedSpotId=i,this.encryptedAdPing=s,this.creativeType=r,this.templates=o,this.width=c,this.height=l,this.sequence=d,this.rotationMax=m,this.aspectRatioId=p,this.advertiserDomain=g,this.displayedIds=b,this.display=S,this.frequency=R,this.scalable=F,this.renderTagType=x}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getEncryptedAdPing(){return this.encryptedAdPing}getCreativeType(){return this.creativeType}getImpressionUrls(){return this.impressionUrls}getTemplate(e){return this.templates?this.templates[e]:void 0}getAdomains(){return this.advertiserDomain}getSize(){const e=this.width!=null&&this.width>0,t=this.height!=null&&this.height>0;return e&&t?{width:this.width,height:this.height}:void 0}getSequence(){return this.sequence}getRotationMax(){return this.rotationMax==null?void 0:this.rotationMax}isExecutableRotation(){const e=this.getRotationMax(),t=this.getSequence();return e==null||t==null?!1:e+1>=t}createRotationParams(){return{impression_id:this.impressionId,creative_type:this.creativeType,sequence:String(this.sequence),aspect_ratio_id:this.aspectRatioId,adomains:this.advertiserDomain?JSON.parse(this.advertiserDomain)||[]:void 0,displayed_ids:this.displayedIds,frequency:this.frequency}}isOverlay(){return this.display==="overlay"||this.display==="interstitial"}getFrequencyParams(){if(this.frequency!=null)return{key:this.frequency.key,domain:oe.convertDomain(this.frequency.domain),rewardedSec:this.frequency.rewarded_sec}}isScalable(){return this.scalable==null?!1:this.scalable}getRenderTagType(){return this.renderTagType}}const Ie={isExternalDisplayAd(n){if(n.render_tag_type==="outside")return!0;const t=n.creative_type==="banner",i=n.width?Number(n.width)===0:!0,s=n.height?Number(n.height)===0:!0;return t&&i&&s},isInitialSequence(n){const e=Number(n.sequence);return!Number.isNaN(e)&&e===2}};class Vt extends Pe{constructor(e,t,i,s,r,o,c,l,d,m,p,g,b,S,R,F,x,q){super(e,i,s,r,o,d,void 0,void 0,m,p,g,b,S,R,F,x,q),this.impressionTag=t,this.adTag=c,this.nativeCss=l}getAd(){return{html:this.adTag,css:this.nativeCss,js:""}}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class Wt extends Pe{constructor(e,t,i,s,r,o,c,l,d,m,p,g,b,S,R,F,x,q,B){super(e,i,s,r,o,l,d,m,p,g,b,S,R,F,x,q,B),this.impressionTag=t,this.adTag=c}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class jt extends Pe{constructor(e,t,i,s,r,o,c,l,d,m,p,g,b,S,R,F,x,q,B,le){super(e,t,i,s,r,c,l,d,m,p,g,b,S,R,q,B,le),this.adTag=o,this.landingPageUrl=F,this.clickTrackingUrls=x}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){}getLandingPageUrl(){return this.landingPageUrl}getClickTrackingUrls(){return this.clickTrackingUrls}}const h={NOT_EXIST:2e4,EMPTY:20001,NOT_A_NUMBER:20002,NEGATIVE_NUMBER:20003,INVALID_SPECIFICATION:20004,CALLED_BEFORE_READY:20200,CALLED_AFTER_NO_AD:20201,CALLED_MULTIPLE_TIMES:20202,CALLED_AT_AUTO_PLAY:20203};class f extends Error{constructor(t,i,s){super(t);a(this,"reportingMessage");this.message=t,this.errorCode=i,this.withItems=s,this.reportingMessage=this.convertForReportMessage()}convertForReportMessage(){let t="";switch(this.errorCode){case h.NOT_EXIST:t=`Cant find value (${this.message})`;break;case h.EMPTY:t=`Value is empty string (${this.message})`;break;case h.NOT_A_NUMBER:t=`Value is not a number (${this.message})`;break;case h.NEGATIVE_NUMBER:t=`Value is negative number (${this.message})`;break;case h.INVALID_SPECIFICATION:t=`Value is invalid (${this.message})`;break;case h.CALLED_BEFORE_READY:t=`Called to display() before adResponse reached (${this.message})`;break;case h.CALLED_AFTER_NO_AD:t=`Called to undefined display() (${this.message})`;break;case h.CALLED_MULTIPLE_TIMES:t=`Called to display() that has already been called (${this.message})`;break;case h.CALLED_AT_AUTO_PLAY:t=`Called to display() on an offerwall reward ad (${this.message})`;break;default:t=this.message}if(this.withItems==null)return t;const i=this.withItems.join(",").trim();return`${t} with ${i}`}}class ae{of(e){var g;const t=this.validateImpressionId(e.impression_id),i=this.validateSpotId(e.spot),s=this.validateSequence(e.sequence);if(e.frequency&&this.isCollectFrequencyParams(e.frequency),!e.adtag)return;const r=this.validateRotationMax(e.rotation_max,e.adtag),o=this.validateEp(e.ep),c=e.width!=null?Number(e.width):void 0,l=e.height!=null?Number(e.height):void 0,d=Array.isArray(e.imp_urls)?e.imp_urls:[],m=this.validateBooleanNumber(e.scalable,"scalable"),p=this.validateRenderTagType(e.render_tag_type);switch(e.creative_type){case"banner":return new Wt(t,e.imptag,d,i,o,e.creative_type,e.adtag,e.templates,c,l,s,r,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.frequency,m,p);case"native":return new Vt(t,e.imptag,d,i,o,e.creative_type,e.adtag,e.nativecss,e.templates,s,r,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.frequency,m,p);case"video":return this.validateClickThroughUrl(e),new jt(t,d,i,o,e.creative_type,e.adtag,e.templates,c,l,s,r,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.ext.click_through_url,((g=e.ext)==null?void 0:g.click_tracking_urls)||[],e.frequency,m,p);default:return}}validateBooleanNumber(e,t){const i={TRUE:1,FALSE:0};if(e==null)return;const s=Number(e);if(s===i.TRUE)return!0;if(s===i.FALSE)return!1;throw new f(`${t}`,h.INVALID_SPECIFICATION)}validateImpressionId(e){if(e==null)throw new f("impression_id",h.NOT_EXIST);return e}validateSpotId(e){if(e==null)throw new f("spot",h.NOT_EXIST);return e}validateClickThroughUrl(e){var t;if(e.creative_type!=="video")return"";if(!((t=e.ext)!=null&&t.click_through_url))throw new f("ext.click_through_url",h.NOT_EXIST);return e.ext.click_through_url}validateSequence(e){if(e==null)throw new f("sequence",h.NOT_EXIST);const t=Number(e);if(Number.isNaN(t))throw new f("sequence",h.NOT_A_NUMBER);return t}validateEp(e){if(e==null)throw new f("ep",h.NOT_EXIST);return e}validateRotationMax(e,t){if(e==null){if(t==null)return;throw new f("rotation_max",h.NOT_EXIST,["adtag"])}const i=Number(e);if(Number.isNaN(i))throw new f("rotation_max",h.NOT_A_NUMBER);return i}validateRenderTagType(e){switch(e){case"iframe":case void 0:case null:return e??"iframe";case"div":return e;case"none":return e;case"outside":return e;default:throw new f("adResponse.render_tag_type",h.INVALID_SPECIFICATION)}}getFrequencyParam(e){if(this.validateImpressionId(e.impression_id),this.validateSpotId(e.spot),this.validateSequence(e.sequence),this.validateRotationMax(e.rotation_max,e.adtag),this.validateClickThroughUrl(e),e.frequency!=null)return this.isCollectFrequencyParams(e.frequency),{key:e.frequency.key,domain:oe.convertDomain(e.frequency.domain),rewardedSec:Number(e.frequency.rewarded_sec)}}isCollectFrequencyParams(e){if(e.key==null)throw new f("frequency.key",h.NOT_EXIST);if(e.domain==null)throw new f("frequency.domain",h.NOT_EXIST);if(e.rewarded_sec==null)throw new f("frequency.rewarded_sec",h.NOT_EXIST);if(e.domain==="")throw new f("frequency.domain",h.EMPTY);const t=Number(e.domain.replace("{","").replace("}",""));if(Number.isInteger(t)&&t<1)throw new f("frequency.domain",h.INVALID_SPECIFICATION);const i=Number(e.rewarded_sec);if(Number.isNaN(i))throw new f("frequency.rewarded_sec",h.NOT_A_NUMBER);if(i<0)throw new f("frequency.rewarded_sec",h.NEGATIVE_NUMBER);return!0}}class Kt{constructor(e){a(this,"adResponseAdapter");a(this,"adRequestAdapter");this.microadCompass=e,this.adRequestAdapter=new ne,this.adResponseAdapter=new ae}renderingAnyTemplate(e,t){var c;const i=t.getImpressionId(),s=(c=this.microadCompass.selectTemplate(i))==null?void 0:c.main,r=t.getTemplate(_.MAIN),o=t.getTemplate(_.CONFIRM);if(s!=null&&t.getFrequencyParams()==null)ke.reRendering(s,e,t);else if(o!=null&&r!=null)it.rendering(i,e,t,this.microadCompass);else if(r!=null)ke.rendering(i,e,t,this.microadCompass);else throw new Error("[COMPASS-JS] Cant find required template's HTML. therefore, advertisement is not display.")}hideTemplate(e){const t=this.microadCompass.selectTemplate(e.impression_id),i=t==null?void 0:t.main,s=t==null?void 0:t.confirm;i!=null&&i.hideTemplate(e.spot),s!=null&&s.hideTemplate(e.spot)}rendering(e,t){var i;try{const s=this.adRequestAdapter.of(e),r=this.adResponseAdapter.of(t);r!=null?this.renderingAnyTemplate(s,r):(e.spot&&this.microadCompass.selectMicroadCompassAdomains().clearAdomains(e.spot),new _e(t.imptag,this.microadCompass.selectMicroadCompassFrequency(),s,void 0,void 0,void 0,!((i=this.microadCompass.selectTemplate(t.impression_id))!=null&&i.main)).receive(),this.hideTemplate(t))}catch(s){throw this.hideTemplate(t),e.spot&&this.microadCompass.selectMicroadCompassFrequency().cancel(e.spot),new Error(s.message)}}}class Ue{constructor(e){this.urls=e}receive(){const e=new Oe(this.urls).createByURL();e==null||e.fire()}}class Gt{createElement(e,t){const i=document.createElement(e);return t==null||Object.entries(t).forEach(([s,r])=>{s in i.style&&i.style[s]!=null&&(i.style[s]=r)}),i}insertScriptText(e,t){t.forEach(i=>{e.insertAdjacentText("beforeend",i)})}}class Jt{constructor(e,t,i=new Gt){this.adRequest=e,this.adResponse=t,this.repository=i}load(){const e={width:"0px",height:"0px",display:"none"},t=this.repository.createElement("div",e),i=this.repository.createElement("script");t.appendChild(i),this.writeScriptText(i),this.writeWrapperTag(t),document.body.appendChild(t)}writeScriptText(e){const t=["window.microadCompassWrapperRequest = window.microadCompassWrapperRequest || {};",`window.microadCompassWrapperRequest.request = ${JSON.stringify(this.adRequest)};`,`window.microadCompassWrapperRequest.response = ${JSON.stringify(this.adResponse)};`];this.repository.insertScriptText(e,t)}writeWrapperTag(e){const t=document.createRange().createContextualFragment(this.adResponse.adtag);Array.from(t.children).forEach(i=>{e.insertAdjacentElement("beforeend",i)})}}class W{static execute(e,t,i){if(!(!e||!t))try{const s="https://deb.send.microad.jp/adtag_error",r=W.createParameter(e,t,i.errorCode,i.reportingMessage);new Image().src=`${encodeURI(s)}?${r}`}catch(s){s instanceof Error&&y.log(s.message)}}static createParameter(e,t,i,s){const r={ep:e,ct:t,ver:"0.9.4",ec:i,etc:s,test:W.isDebugMode()?1:0};return Object.entries(r).filter(([,o])=>o!=null).map(([o,c])=>`${o}=${encodeURIComponent(String(c))}`).join("&")}static isDebugMode(){return"false".toLowerCase()==="true"}}class zt{constructor(e,t=new ne,i=new ae){this.microadCompass=e,this.adRequestAdapter=t,this.adResponseAdapter=i}load(e,t){try{this.adRequestAdapter.of(e),this.adResponseAdapter.of(t)==null?(y.log("NoAdであるため広告描画を終了します。"),this.executeNoAdProcess(t)):new Jt(e,t).load()}catch(i){this.forceQuitDisplay(t,i)}}executeNoAdProcess(e){new Ue(e.imp_urls||[]).receive(),this.hideTemplate(e.spot,e.impression_id)}forceQuitDisplay(e,t){const i=t instanceof f,s=i?t.reportingMessage:"詳細情報なし";y.log(`エラーが発生したため広告描画を終了します。(${s})`),i&&W.execute(e.ep,e.creative_type,t),this.hideTemplate(e.spot,e.impression_id)}hideTemplate(e,t){var s,r;const i=this.microadCompass.selectTemplate(t);(s=i==null?void 0:i.main)==null||s.hideTemplate(e),(r=i==null?void 0:i.confirm)==null||r.hideTemplate(e)}}class Xt{constructor(e,t,i,s,r=2e3,o=()=>"",c=()=>"",l=()=>"",d=()=>"",m=()=>"",p=()=>"",g=()=>"",b=new A(i.getEncryptedSpotId())){this.microadCompass=e,this.wrapper=s,this.timeout=r,this.onReadyProcess=o,this.onGrantedProcess=c,this.onCompletedProcess=l,this.onCloseProcess=d,this.onTimeout=m,this.onError=p,this.onDisplayed=g,this.templateFrameRepository=b,this.onReadyProcess=this.displayConfirmTemplate.bind(this,t,i),this.onGrantedProcess=this.grantReward.bind(this,t,i),this.onDisplayed=this.fireImpression.bind(this,i),this.onCloseProcess=this.removeUnNecessaryElementClose.bind(this,i),this.onTimeout=S=>this.removeUnNecessaryElementTimeOut.bind(this,i)(S),this.onError=(S,R)=>this.reporting.bind(void 0,i)(S,R),this.onCompletedProcess=this.completed.bind(this,i)}async ready(){await this.wrapper.loading(),this.wrapper.enableService(this.timeout,this.onReadyProcess,this.onGrantedProcess,this.onCloseProcess,this.onTimeout,this.onError,window,this.onCompletedProcess)}displayConfirmTemplate(e,t){if(t.getTemplate(_.CONFIRM)==null){this.display();return}it.rendering.bind(void 0,t.getImpressionId(),e,t,this.microadCompass)();const i=this.templateFrameRepository.selectElement("compassSpotTemplateNextTemplateButton");i!=null&&(i.onclick=this.display.bind(this))}display(){this.wrapper.display(this.onDisplayed),this.templateFrameRepository.hideFrameElement()}fireImpression(e){new Ue(e.getImpressionUrls()).receive(),v.notifyViewableImpression(e.getEncryptedSpotId())}grantReward(e,t){const i=this.microadCompass.selectMicroadCompassFrequency(),s=t.getFrequencyParams();if(s==null)return;const{key:r,domain:o}=s,c=t.getEncryptedSpotId(),l=i.getCustomKeyValues(e,r),d=i.selectFrequency(c,l,o);d==null||d.resetFrequency(i.generateKeyForSpot(c)),v.notifyAdGranted(c)}completed(e){v.notifyAdEnded(e.getEncryptedSpotId())}removeUnNecessaryElementClose(e){this.templateFrameRepository.hideFrameElement.bind(this.templateFrameRepository)(),v.notifyAdClosed(e.getEncryptedSpotId())}removeUnNecessaryElementTimeOut(e,t){this.templateFrameRepository.hideFrameElement.bind(this.templateFrameRepository)(),t&&v.notifyNoAd(e.getEncryptedSpotId(),t)}reporting(e,t,i){const s=e.getEncryptedAdPing(),r=e.getCreativeType(),o=new f(i,t);W.execute(s,r,o)}}class Yt{constructor(e,t=new ne,i=new ae){this.microadCompass=e,this.adRequestAdapter=t,this.adResponseAdapter=i}async rendering(e,t,i){y.log("外部リワード機能を用いた広告描画を開始します。");try{const s=this.adRequestAdapter.of(e),r=this.adResponseAdapter.of(t);r==null?(y.log("NoAdであるため広告描画を終了します。"),this.executeNoAdProcess(t)):await new Xt(this.microadCompass,s,r,i).ready()}catch(s){this.forceQuitDisplay(t,s)}}executeNoAdProcess(e){new Ue(e.imp_urls||[]).receive(),this.hideTemplate(e.spot,e.impression_id)}forceQuitDisplay(e,t){const i=t instanceof f,s=i?t.reportingMessage:"詳細情報なし";y.log(`エラーが発生したため広告描画を終了します。(${s})`),i&&W.execute(e.ep,e.creative_type,t),this.hideTemplate(e.spot,e.impression_id)}hideTemplate(e,t){var s,r;const i=this.microadCompass.selectTemplate(t);(s=i==null?void 0:i.main)==null||s.hideTemplate(e),(r=i==null?void 0:i.confirm)==null||r.hideTemplate(e)}}class Qt{constructor(e){a(this,"vastConverter");this.vastConverter=e.VastConverter.call({...e}.VastConverter.prototype)}convert(e,t){this.vastConverter.execute(e,t)}}class $e{readCookie(e){const i=this.readCookies().filter(s=>s.key===e);return i.length>0?i.slice(-1)[0].value:void 0}writeCookie(e,t,i,s){document.cookie=`${e}=${t}; domain=${i}; max-age=${s}; path=/;`}isLocalStorageAvailable(){const e="__test_localStorage_access__";try{return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}readLocalStorage(e){try{return localStorage.getItem(e)}catch{return}}writeLocalStorage(e,t){try{localStorage.setItem(e,t);return}catch{return}}appendScriptTag(e,t,i){const s=t.createElement("script");s.src=e,i.appendChild(s)}readCookies(){return document.cookie==null||document.cookie===""?[]:document.cookie.split(";").map(e=>{const[t,i]=e.split("=");return{key:(t==null?void 0:t.trim())||"",value:(i==null?void 0:i.trim())||""}})}}class rt{constructor(e,t,i,s,r=oe.createTopLevelDomainPlusOne(),o=new $e){this.microadCompassDefine=e,this.audienceType=t,this.key=i,this.maxAge=s,this.domain=r,this.trackerRepository=o}read(){const e=this.microadCompassDefine.aids.find(t=>t.type===this.audienceType);return e==null?void 0:e.id}async write(e){return new Promise(t=>{if(e==null){t();return}this.trackerRepository.writeCookie(this.key,e,this.domain,this.maxAge);const i=this.trackerRepository.readCookie(this.key);this.addAids(i),t()})}addAids(e){e!=null&&this.microadCompassDefine.aids.push({type:this.audienceType,id:e})}}class Me extends rt{constructor(e){const i="_unv_id";super(e,21,i,3600)}read(){return super.read()}async write(e){if(e){await super.write(e);return}const t=this.trackerRepository.readCookie(this.key);t&&await super.write(t)}}class Zt{constructor(e,t,i=new ne,s=new ae){this.microadCompassDefine=e,this.microadCompass=t,this.adRequestAdapter=i,this.adResponseAdapter=s}callback(e){this.writeUniverseIdIfPresent(e),new Qt(this.microadCompassDefine).convert(e,this.handleAdRendering.bind(this))}writeUniverseIdIfPresent(e){const t=e._unv_id;t&&new Me(this.microadCompassDefine).write(t)}handleAdRendering(e){var i,s;const t=new I().getAdRequestBySpot(e.spot);try{const r=this.adResponseAdapter.of(e);if(this.notifyNoAdEvent(r,e),Ie.isInitialSequence(e)&&e.frequency!=null&&this.microadCompass.selectMicroadCompassFrequency().updateCounter(t,e,!0),r==null){new _e(e.imptag,this.microadCompass.selectMicroadCompassFrequency(),this.adRequestAdapter.of(t),void 0,void 0,void 0,!((i=this.microadCompass.selectTemplate(e.impression_id))!=null&&i.main)).receive(),this.hideTemplate(e);return}const o=(s=this.microadCompassDefine.adServiceSettings)==null?void 0:s.getAdService(r.getEncryptedSpotId());if(o==null)return;o.setAdPing(r.getEncryptedAdPing()),o.setCreativeType(r.getCreativeType()),o.isManualDisplay?(o.setDisplay(this.adRenderingBy.bind(this,e,t)),v.notifyAdReady(e.spot)):this.adRenderingBy(e,t)}catch{v.notifyNoAd(e.spot,"unexpectedError")}}notifyNoAdEvent(e,t){const i=e==null;if(i&&t.frequency!=null){v.notifyNoAd(t.spot,"noAdAvailable");return}if(i){v.notifyNoAd(t.spot,"noAdObtained");return}const s=Ie.isExternalDisplayAd(t);!t.templates&&!s&&v.notifyNoAd(t.spot,"unexpectedError")}hideTemplate(e){const t=this.microadCompass.selectTemplate(e.impression_id),i=t==null?void 0:t.main,s=t==null?void 0:t.confirm;i!=null&&i.hideTemplate(e.spot),s!=null&&s.hideTemplate(e.spot)}adRenderingBy(e,t){Ie.isExternalDisplayAd(e)?this.microadCompassDefine.loadAdNonIframeDisplay(t,e):this.microadCompassDefine.ad.selectDisplayFunc()(t,e)}}class ei extends Be{constructor(t,i){if(!(i!=null&&i.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();a(this,"acceptClickEvent");a(this,"frame");this.frame=new De(i,t,Ne,!0);const s=this.generateSubscribe(t);this.acceptClickEvent=new de([s])}generateSubscribe(t){return new qe(t)}rendering(){this.frame.rendering()}}const ti={rendering:(n,e,t,i)=>{var r,o;const s=new ei(n,t);i.registerTemplateByImpression(e,_.CONFIRM,s),(o=(r=i.selectTemplate(e))==null?void 0:r.confirm)==null||o.rendering()}};class ii{constructor(e){this.microadCompass=e}hideTemplate(e,t){var i,s;(s=(i=this.microadCompass.selectTemplate(t))==null?void 0:i.confirm)==null||s.hideTemplate(e)}render({encryptedSpotId:e,impressionId:t,confirmTemplate:i}){try{ti.rendering(e,t,i,this.microadCompass)}catch(s){throw this.hideTemplate(e,t),s}}}const we=class we{selectRelayData(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],frequencyCode:i[1]}})}selectFrequencyCode(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],counter:i[1],time:i[2]}})}registerRelayData(e,t,i){const s=new Date().getTime();this.writeCookie(e,`[${s}, "${t}"]`,i)}register(e){const t=e.getKey(),i=e.getCounter(),s=e.getRewardedTime(),r=new Date().getTime(),o=e.getDomain();o!=null&&this.writeCookie(t,`[${r}, ${i}, ${s}]`,o)}getCookiesFromBrowser(){var e;return document.cookie==null?[]:(e=document.cookie)==null?void 0:e.split(";").map(t=>{const[i,s]=t.split("=");return{key:i.trim(),value:s}})}writeCookie(e,t,i,s=we.cookieExpirationSec){document.cookie=`${e}=${t}; domain=${i}; max-age=${s}; path=/;`}};a(we,"cookieExpirationSec",604800);let ye=we;class si{constructor(e,t=[]){a(this,"MARKER_TEMPORARY_ID","frequency-temporary");this.id=e,this.measures=t}start(){const e=this.measures.slice(-1)[0];if(e!=null&&e.finish==null)return;const t=this.getStartId(this.measures.length);this.measures.push({start:performance.mark(t),finish:void 0})}finish(){const e=this.measures.slice(-1)[0];if((e==null?void 0:e.start)==null||(e==null?void 0:e.finish)!=null)return;const t=this.measures.length-1,i=this.getFinishId(t);this.measures[t].finish=performance.mark(i)}getTotalDuration(e=void 0){const t=this.measures.length-1,i=this.measures.reduce((s,r,o)=>{const c=t===o;if(r.start==null||!c&&r.finish==null)return s;r.finish==null&&(performance.clearMarks(this.MARKER_TEMPORARY_ID),performance.mark(this.MARKER_TEMPORARY_ID,e==null?void 0:{startTime:e}));const l=performance.measure(this.getResultId(o),this.getStartId(o),c&&r.finish==null?this.MARKER_TEMPORARY_ID:this.getFinishId(o));return s+l.duration},0);return Math.round(i)}reset(){this.measures=[]}getStartId(e){return`${this.getCommonId(e)}-start`}getFinishId(e){return`${this.getCommonId(e)}-finish`}getResultId(e){return`${this.getCommonId(e)}-result`}getCommonId(e){return`${this.id}-${e}`}}class ri{constructor(e,t,i,s,r,o=new ye,c=!1){a(this,"measure");a(this,"clockId");a(this,"remainingTimeId");a(this,"isClockLocked");this.id=e,this.key=t,this.counter=i,this.rewardedTime=s,this.domain=r,this.frequencyRepository=o,this.isReachedReward=c,this.measure=new si(this.id),this.clockId=void 0,this.remainingTimeId=void 0,this.isClockLocked=!1}getKey(){return this.key}getCounter(){return this.counter}getRewardedTime(){return this.rewardedTime}getDomain(){return this.domain}countUp(e){this.counter+=1,this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}resetFrequency(e){this.counter=0,this.rewardedTime=Math.floor(new Date().getTime()/1e3),this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}reachReward(){this.isReachedReward=!0}getTotalDurationSec(){return Math.floor(this.measure.getTotalDuration()/1e3)}setTheClock(e,t,i){this.clockId=setInterval(()=>{this.clockId!=null&&(e>this.getTotalDurationSec()&&!this.isReachedReward||(this.resetFrequency(t),i(),clearInterval(this.clockId)))},1)}getRemainingTime(e){return e-this.getTotalDurationSec()}getRemainingTimeSync(e,t,i){let s=e;this.remainingTimeId=setInterval(()=>{if(this.remainingTimeId==null)return;const r=this.getRemainingTime(e);s!==r&&(s=r,t(r),!(r>0&&!this.isReachedReward)&&(i(),r<0&&t(0),y.log(`報酬獲得処理が完了しました。(獲得時間： ${new Date().getTime()/1e3})`),clearInterval(this.remainingTimeId)))},1)}cancel(){this.clockId!=null&&(clearInterval(this.clockId),this.clockId=void 0),this.remainingTimeId!=null&&(clearInterval(this.remainingTimeId),this.remainingTimeId=void 0),this.isClockLocked=!1,this.measure.reset()}startTheClock(){this.isClockLocked||this.measure.start()}pauseTheClock(){this.measure.finish()}lockClock(){this.isClockLocked=!0}unlockClock(){this.isClockLocked=!1}isEqual(e){return this.key===e}}const be={of:(n,e,t,i,s=0)=>new ri(n,e,s,t,i)};class ni{constructor(e,t,i,s=!1){a(this,"templateFrameRepository");a(this,"templateRepository");a(this,"targetWindow");a(this,"intersectionObserver");a(this,"inViewFunction");a(this,"outViewFunction");this.inViewRate=t,this.targetElement=i,this.isInviewing=s,this.inViewFunction=void 0,this.outViewFunction=void 0,this.templateFrameRepository=new A(e),this.templateRepository=new L}connect(e,t){e();const i=()=>{this.isInviewing=!0,this.isInviewing&&e()},s=()=>{this.isInviewing=!1,this.isInviewing||t()};this.inViewFunction=i,this.outViewFunction=s,this.targetWindow=this.templateFrameRepository.selectWindow(),this.setIntersectionObserver(i,s),this.targetWindow!=null&&this.setFocusObserver(this.targetWindow,i,s)}disconnect(){var i;if((i=this.intersectionObserver)==null||i.disconnect(),this.targetWindow==null||this.inViewFunction==null||this.outViewFunction==null)return;const e=this.inViewFunction,t=this.outViewFunction;this.removeHistoryBackEventListener(this.targetWindow,e,t),this.removeVisibilityChangeEventListener(this.targetWindow,this.getVisibilityChangeEventListener(this.inViewFunction,this.outViewFunction))}setIntersectionObserver(e,t){this.intersectionObserver=new IntersectionObserver(i=>{const s=i.find(r=>r.target===this.targetElement);s!=null&&(s.intersectionRatio>=this.inViewRate?(this.isInviewing=!0,e()):(this.isInviewing=!1,t()))},{threshold:[this.inViewRate]}),this.intersectionObserver.observe(this.targetElement)}setFocusObserver(e,t,i){const s=e.document.querySelector("iframe");this.addHistoryBackEventListener(e,t,i),s!=null&&s.contentWindow&&s.id==="compassSpotTemplateAdWrapper"?this.addVisibilityChangeEventListener(s.contentWindow,this.getVisibilityChangeEventListener(t,i)):this.addVisibilityChangeEventListener(e,this.getVisibilityChangeEventListener(t,i))}addHistoryBackEventListener(e,t,i){this.templateRepository.activeMovePageHistoryEvent(e,t,i),e!==e.top&&this.addHistoryBackEventListener(e.parent,t,i)}addVisibilityChangeEventListener(e,t){this.templateRepository.activeVisibilityChangeEvent(e,t),e!==e.top&&this.addVisibilityChangeEventListener(e.parent,t)}removeHistoryBackEventListener(e,t,i){this.templateRepository.inactiveMovePageHistoryEvent(e,t,i),e!==e.top&&this.removeHistoryBackEventListener(e.parent,t,i)}removeVisibilityChangeEventListener(e,t){this.templateRepository.inactiveVisibilityChangeEvent(e,t),e!==e.top&&this.removeVisibilityChangeEventListener(e.parent,t)}getVisibilityChangeEventListener(e,t){return()=>{window.document.hidden?t():e()}}}const oi=.5,Ge=/\${[A-Za-z0-9]+}/g;class ai{constructor(e=new ye,t=void 0,i={}){a(this,"selectInsertFrequency",(e,t,i)=>{this.resetFrequencyData(e,t);const s=this.getCustomKeyValues(e,t.key),r=this.selectFrequency(i,s,t.domain);if(r==null)throw new Error("[COMPASS-JS] Cant find registered frequency cookies. therefore, advertisement is not display.");return r});this.frequencyRepository=e,this.viewableOperator=t,this.frequencies=i}buildFrequencyControlParameter(e,t){const i=this.selectFrequencyCode(e,t||{});if(i!=null)return{counter:i.counter||0,time:i.time==null?null:String(i.time)}}getCustomKeyValues(e,t){const i=t.match(Ge);if(i==null)return{};const s=i.map(r=>r.replace(/^\${/,"").replace(/}$/,""));return e.createFrequencyCustomKeyParameters(s)}selectFrequencyCodeKey(e,t){const i=this.generateKeyForSpot(e),s=this.getFrequencyRelay(i);return s==null?void 0:this.generateKeyForFrequency(s.frequencyCode,t)}selectFrequencyCode(e,t){const i=this.selectFrequencyCodeKey(e,t);return i==null?void 0:this.getFrequencyCode(i)}selectFrequency(e,t,i){const s=this.selectFrequencyCodeKey(e,t);if(s==null)return null;const r=this.getFrequencyCode(s);if(r==null)return null;if(this.frequencies[e]==null){const c=be.of(`${e}-${Date.now()}-frequency`,s,r.time,i,r.counter);this.registerFrequencyByEncryptedSpotId(e,c)}return this.frequencies[e]}registerFrequencyData(e,t,i){const s=be.of(`${t}-${Date.now()}-frequency`,e,null,i.domain);this.frequencyRepository.register(s)}registerFrequencyByEncryptedSpotId(e,t){this.frequencies={...this.frequencies,[e]:t}}updateCounter(e,t,i=!1){const s=new ne().of(e),r=s.getEncryptedSpotId(),o=new ae().getFrequencyParam(t);if(r==null||o==null)return;const c=new I().getMicroadCompassAdServiceSettings().getAdService(r),l=this.getCustomKeyValues(s,o.key);let d=this.selectFrequency(r,l,o.domain);d==null&&(d=this.selectInsertFrequency(s,o,r));const m=this.generateKeyForFrequency(o.key,l);d.isEqual(m)||(d=this.selectInsertFrequency(s,o,r)),!c.isFrequencyCounted&&(d.countUp(this.generateKeyForSpot(r)),i&&c.markAsFrequencyCounted())}notify(e,t,i){const s=new ne().of(t),r=new ae().of(i);this.callRewardAcquisitionProcess(s,r==null?void 0:r.getAd().html,r==null?void 0:r.getFrequencyParams(),e)}callRewardAcquisitionProcess(e,t,i,s){const r=e.getEncryptedSpotId();if(r==null||i==null)return;const o=this.frequencies[r];if(o==null)throw new Error("[COMPASS-JS] callRewardAcquisitionProcess() has to be called after it is called updateCounter().");const c=s==null?void 0:document.getElementById(s);t&&c&&o&&(this.viewableOperator=new ni(r,oi,c),this.viewableOperator.connect(o.startTheClock.bind(o),o.pauseTheClock.bind(o)),o.setTheClock(i.rewardedSec,this.generateKeyForSpot(r),this.viewableOperator.disconnect.bind(this.viewableOperator)))}cancel(e){var i;const t=this.frequencies[e];t!=null&&(t.cancel(),(i=this.viewableOperator)==null||i.disconnect())}resetFrequencyData(e,t){const i=e.getEncryptedSpotId();if(t==null||i==null)return;const s=this.generateKeyForSpot(i),r=this.getFrequencyRelay(s);(r==null||r.frequencyCode!==t.key)&&this.frequencyRepository.registerRelayData(s,t.key,t.domain);const o=this.getFrequencyRelay(s);if(o==null)return;const c=this.getCustomKeyValues(e,t.key),l=this.generateKeyForFrequency(o.frequencyCode,c);this.getFrequencyCode(l)==null&&this.registerFrequencyData(l,i,t);const d=this.getFrequencyCode(l),m=be.of(`${i}-${Date.now()}-frequency`,l,(d==null?void 0:d.time)??null,t.domain,d==null?void 0:d.counter);this.registerFrequencyByEncryptedSpotId(i,m)}generateKeyForSpot(e){return`_mafc_${e}`}getFrequencyRelay(e){const t=this.frequencyRepository.selectRelayData(e);return t.length===0?null:t.reduce((i,s)=>i.updateTime==null||s.updateTime>i.updateTime?s:i,{})}getFrequencyCode(e){const t=this.frequencyRepository.selectFrequencyCode(e);return t.length===0?null:t.reduce((i,s)=>i.updateTime==null||s.updateTime>i.updateTime?s:i,{})}generateKeyForFrequency(e,t){const i=e.match(Ge);return i==null?e:i.reduce((s,r)=>{const o=r.replace(/^\${/,"").replace(/}$/,""),c=t[o]==null?"":t[o];return c==null?s:s.replace(`${r}`,c)},e)}}class ci{constructor(e=new pe){this.admoainsRepository=e}selectAdomains(e){return this.admoainsRepository.selectExcludeImpressedAdsSpotIds().includes(e)?this.admoainsRepository.selectExcludeImpressedAdsAdomains():[]}clearAdomains(e){this.admoainsRepository.selectExcludeImpressedAdsSpotIds().includes(e)&&this.admoainsRepository.clearAdomains()}}class nt{constructor(e,t,i,s=new $e){this.microadCompassDefine=e,this.audienceType=t,this.timeout=i,this.trackerRepository=s}read(){const e=this.microadCompassDefine.aids.find(t=>t.type===this.audienceType);return e==null?void 0:e.id}addAids(e){e!=null&&this.microadCompassDefine.aids.push({type:this.audienceType,id:e})}}class li extends nt{constructor(e,t="https://cache.send.microad.jp/js/cookie_loader.html",i="https://cache.send.microad.jp"){super(e,14,0),this.cookieUrl=t,this.cacheUrl=i}async write(){return this.loadMicroadCookies()}loadMicroadCookies(){return new Promise(e=>{const t=this.createIframe(),{body:i}=document;if(i===null){const r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r)}else i.appendChild(t);t.src=this.cookieUrl;const s=r=>{r.origin===this.cacheUrl&&typeof r.data.rtus<"u"&&r.data.rtus!==null&&(this.microadCompassDefine.rtusId=encodeURIComponent(r.data.rtus),window.removeEventListener("message",s,!1),e())};window.addEventListener("message",s,!1)})}createIframe(){const e=document.createElement("iframe");return e.width="1",e.height="1",e.frameBorder="0",e.setAttribute("style","position:absolute; top:-9999px; left: -9999px; border-style: none"),e}}class di{constructor(e,t,i,s,r){a(this,"handleMessage",e=>{if(e.origin!==this.cacheUrl)return;const t=e.data==null?void 0:e.data.tr;typeof t!="string"||t.length===0||this.isInvalidTR(t)||this.onSync(t,this.maxAge)});this.cookieUrl=e,this.cacheUrl=t,this.maxAge=i,this.document=s,this.onSync=r}sync(){this.injectIframe(),window.addEventListener("message",this.handleMessage)}injectIframe(){const e=this.document.createElement("iframe");e.width="1",e.height="1",e.setAttribute("style","position:absolute; top:-9999px; left: -9999px; border-style: none"),e.id="universe_3rd_cookie_tr",e.src=this.cookieUrl,this.document.body.appendChild(e)}isInvalidTR(e){return!e||e.length>=80}}class hi extends rt{constructor(e){const i="_unv_aid";super(e,2,i,7776e3)}async write(){const{document:e}=window;new di("https://cache.send.microad.jp/fpc/get-tr.html","https://cache.send.microad.jp",this.maxAge,e,(t,i)=>{this.set1stCookieFromThirdCookie(t,i)}).sync();try{const t=this.trackerRepository.readCookie(this.key),i=t||crypto.randomUUID();await super.write(i)}catch{await super.write(null)}}set1stCookieFromThirdCookie(e,t){this.trackerRepository.readCookie(this.key)!==e&&this.trackerRepository.writeCookie(this.key,e,this.domain,t)}}const j=class j extends nt{constructor(e,t=j.DEFAULT_CUSTOMER_ID,i=j.DEFAULT_URL){super(e,6,1e3),this.customerId=t,this.url=i}read(){var e;if(this.microadCompassDefine.aids!=null)return(e=this.microadCompassDefine.aids.find(t=>t.type===this.audienceType))==null?void 0:e.id}async write(){return this.trackerRepository.isLocalStorageAvailable()?new Promise(e=>{try{this.trackerRepository.appendScriptTag(this.url,window.document,window.document.body);const t=window;t.IMUIDRequest=t.IMUIDRequest||[],t.IMUIDRequest.push({customerId:this.customerId,callback:i=>{this.addAids(i.uid),e()},callbackTimeout:this.timeout})}catch{e()}}):Promise.resolve()}};a(j,"DEFAULT_CUSTOMER_ID",1011503),a(j,"DEFAULT_URL","https://dmp.im-apps.net/sdk/im-uid.js");let Fe=j;class ot{constructor(e,t,i,s,r=oe.createTopLevelDomainPlusOne(),o=new $e){this.microadCompassDefine=e,this.audienceType=t,this.key=i,this.maxAge=s,this.domain=r,this.trackerRepository=o}read(){const e=this.microadCompassDefine.aids.find(t=>t.type===this.audienceType);return e==null?void 0:e.id}addAids(e){e!=null&&this.microadCompassDefine.aids.push({type:this.audienceType,id:e})}}class mi extends ot{constructor(e){const i="_lr_env";super(e,13,i,3600)}read(){var e;if(this.microadCompassDefine.aids!=null)return(e=this.microadCompassDefine.aids.find(t=>t.type===this.audienceType))==null?void 0:e.id}async write(){const e=this.trackerRepository.readCookie(this.key)||this.trackerRepository.readLocalStorage(this.key),t=this.getId(e);t&&this.addAids(t)}getId(e){if(e==null)return null;let t=null;try{const i=decodeURIComponent(e);if(i==null)return null;t=JSON.parse(atob(i))}catch{return null}return t.envelope==null?null:typeof t.envelope=="string"?t.envelope.trim().length>0?t.envelope:null:Array.isArray(t.envelope)&&t.envelope.length>0&&t.envelope[0].trim().length>0?t.envelope[0]:null}}class ui extends ot{constructor(e){const i="_unv_ehm";super(e,16,i,3600)}async write(){const e=this.trackerRepository.readCookie(this.key)||this.trackerRepository.readLocalStorage(this.key);e&&this.addAids(e)}}class pi{constructor(e,t=30){a(this,"trackers");this.timeoutMs=t,this.trackers=[new hi(e),new Fe(e),new mi(e),new li(e),new ui(e),new Me(e)]}track(){return Promise.race([Promise.all(this.trackers.map(e=>this.addTracker(e))),new Promise(e=>{setTimeout(()=>{e(void 0)},this.timeoutMs)})])}addTracker(e){return e.write()}write(e,t){const i=this.trackers.find(s=>s.audienceType===e);if(i)return i instanceof Me?t==null?void 0:(i.write(t),i.read()):(i.write(),i.read())}read(e){const t=this.trackers.find(i=>i.audienceType===e);return t==null?void 0:t.read()}}const Je={rewarded:w.rewardAdGranted,loaded:w.rewardAdReady,completed:w.rewardAdEnded,closed:w.rewardAdClosed,timeout:w.noAd},ze={haveAdFn:w.rewardAdReady,noAdFn:w.noAd,rewardedFn:w.rewardAdEnded,errorFn:w.noAd};class at{of(e){const t=Object.keys(e);if(this.isMatch(t,w))return e;if(this.isMatch(t,Je))return this.toAdEventByCompass(e,Je);if(this.isMatch(t,ze))return this.toAdEventByCompass(e,ze);const i=Array.from(Object.values(w));return Object.fromEntries(Object.entries(e).filter(([s])=>i.includes(s)))}toAdEventByCompass(e,t){return Object.keys(e).reduce((i,s)=>{const r=t[s];return r&&(i[r]=e[s]),i},{})}isMatch(e,t){const i=Object.keys(t);return e.every(s=>i.includes(s))}}class ct{constructor(){a(this,"params",{})}setUrl(e){return this.params.url=e,this}setReferrer(e){return this.params.referrer=e,this}setIfa(e){return this.params.ifa=e,this}setAppid(e){return this.params.appid=e,this}setGeo(e){return this.params.geo=e,this}setKvSet(e){return this.params.kv_set?Object.assign(this.params.kv_set,e):this.params.kv_set={...e},this}setGpidSlot(e){return this.params.gpt=e,this}showSettings(){return{...this.params}}}class yi{constructor(e,t){a(this,"adRequestRepository");this.adRequest=e,this.selectedAudienceIds=t,this.adRequestRepository=new Xe}receive(){if(this.adRequest.getEncryptedSpotId()==null)return;const e=this.generateCacheBuster(),t=this.adRequest.buildRequestParams(e,this.selectedAudienceIds);new I().addRequestBySpot(t);const i=this.adRequest.createRequestURL({kv_set:t.kv_set},e,this.selectedAudienceIds);this.adRequestRepository.executeRequest(i)}generateCacheBuster(){const e=Math.floor(Math.random()*1e18).toString(16),t=new Date().getTime().toString(16);return e+t}}const gi="0.9.4";class fi{static of(e){var me,He,ue,Ve;const{document:t,microadCompass:i}=window,{spot:s}=e,r="microadCompass.ResponseController.callback",o=this.getEffectiveLocationHref(),c=this.replaceMacro(e.url,"${COMPASS_EXT_URL}"),{referrer:l}=t,d=this.replaceMacro(e.referrer,"${COMPASS_EXT_REF}"),m=this.replaceMacro(e.ifa,"${COMPASS_EXT_IFA}"),p=this.replaceMacro(e.appid,"${COMPASS_EXT_APPID}"),g=(typeof window.IntersectionObserver=="function").toString(),b=this.getSupportedVideoMimes(i.Video.mimes),S=i.rtusId||null,R=this.getAudienceIds(),F=this.getClientHints(),x=this.generateCBT(),q=((He=(me=i.Auctioneer)==null?void 0:me.isAvailableRunAdAuction)==null?void 0:He.call(me).toString())||"false",B=((Ve=(ue=i.Auctioneer)==null?void 0:ue.isAvailableAttributionReportingApi)==null?void 0:Ve.call(ue).toString())||"false",le=`["compass2.js.${gi}"]`,Ce=this.validateGeo(e.geo??""),he=this.validateKvSet(e.kv_set??{}),Ae=this.getFrequency(s,he),{gpid:lt,adservname:dt,adservadslot:ht}=this.getGpidSlot(e.gpt)||{};return new st(s,r,o,c,l,d,m,p,Ce,g,b,S,R,F,x,q,B,le,Ae,he,lt,dt,ht)}static getEffectiveLocationHref(){const e=window.location.href;if(!e.startsWith("about:srcdoc"))return e;try{return window.parent.location.href}catch{return e}}static replaceMacro(e,t){return e?e.replace(t,""):""}static getAudienceIds(){const e=new I().selectAudienceIds();return e&&e.length>0?e:null}static getClientHints(){const e=new I().selectClientHints();return e&&Object.keys(e).length!==0?e:null}static getSupportedVideoMimes(e){const t=window.document.createElement("video");return Array.isArray(e)?e.filter(i=>t.canPlayType(i.type)).map(i=>i.id):[]}static generateCBT(){const e=Math.floor(Math.random()*1e18).toString(16),t=new Date().getTime().toString(16);return e+t}static validateGeo(e){const t=this.replaceMacro(e,"${COMPASS_EXT_GEO}");return t&&/^[0-9.-]+,[0-9.-]+$/.test(t)?t:null}static validateKvSet(e){return e?Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null&&t!=="")):null}static getFrequency(e,t){return new I().selectMicroadCompassFrequency().buildFrequencyControlParameter(e,t)}static getGpidSlot(e){var t,i;return(i=(t=new I().selectMicroadCompassGpid())==null?void 0:t.selectGpidSlot)==null?void 0:i.call(t,e)}}var z,X,Y,Q,Z,ee,te,ie;class vi extends ct{constructor(t,i={}){super();a(this,"isManualDisplay",!1);E(this,z,!1);E(this,X,!1);E(this,Y,!1);E(this,Q,!1);E(this,Z,void 0);E(this,ee,void 0);E(this,te,void 0);E(this,ie,void 0);const s=JSON.parse(JSON.stringify(i));this.params={spot:t,...s},T(this,Z,t),v.setListeners({rewardAdReady:()=>this.notifyRewardAdReady(),noAd:()=>this.notifyNoAd()},!1)}setCreativeType(t){T(this,te,t)}notifyRewardAdReady(){T(this,X,!0)}notifyNoAd(){T(this,Y,!0)}showSettings(){return{...ge.getInstance().showSettings(),...super.showSettings()}}enableManualDisplay(){return this.isManualDisplay=!0,this}request(){const t=fi.of(this.params),i=new I().selectAudienceIds();new yi(t,i).receive(),T(this,X,!1),T(this,Y,!1),T(this,Q,!1),T(this,z,!1)}setAdPing(t){T(this,ee,t)}setDisplay(t){T(this,ie,t)}display(){if(!this.isManualDisplay){this.reportDisplayError(h.CALLED_AT_AUTO_PLAY);return}if(u(this,Q)){this.reportDisplayError(h.CALLED_MULTIPLE_TIMES);return}if(u(this,Y)){this.reportDisplayError(h.CALLED_AFTER_NO_AD);return}if(!u(this,X)){this.reportDisplayError(h.CALLED_BEFORE_READY);return}T(this,Q,!0),u(this,ie)&&u(this,ie).call(this)}reportDisplayError(t){y.log(`DisplayError (adPing: ${u(this,ee)}, creative: ${u(this,te)??"banner"}, spotId: ${u(this,Z)}, code: ${t})`),W.execute(u(this,ee)??"",u(this,te)??"banner",new f(`(spotId: ${u(this,Z)})`,t))}get isFrequencyCounted(){return u(this,z)}markAsFrequencyCounted(){T(this,z,!0)}}z=new WeakMap,X=new WeakMap,Y=new WeakMap,Q=new WeakMap,Z=new WeakMap,ee=new WeakMap,te=new WeakMap,ie=new WeakMap;var se,re;const H=class H extends ct{constructor(){super(...arguments);E(this,se,new Map)}static getInstance(){return u(H,re)||T(H,re,new H),u(H,re)}setListeners(t){const i=new at().of(t);v.setListeners(i)}getAdService(t){return u(this,se).has(t)||u(this,se).set(t,new vi(t,this.params)),u(this,se).get(t)}};se=new WeakMap,re=new WeakMap,E(H,re,null);let ge=H;class Ei{constructor(e=1e3){this.timeoutMs=e}async track(e){const t=await Promise.race([Promise.resolve(this.fetchClientHints()),new Promise(i=>{setTimeout(()=>{i(void 0)},this.timeoutMs)})]);if(this.isClientHintsAllData(t)){const{brands:i,...s}=t;e.ch=s}}isClientHintsAllData(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.mobile=="boolean"&&typeof t.platform=="string"&&Array.isArray(t.brands)}async fetchClientHints(){const e=this.getUserAgentData();if(!(!e||typeof e.getHighEntropyValues!="function"))try{return{...await e.getHighEntropyValues(["architecture","bitness","model","platformVersion","fullVersionList"]),brands:e.brands,mobile:e.mobile,platform:e.platform}}catch{return}}getUserAgentData(){return window.navigator.userAgentData}}const V=class V{constructor(){a(this,"microadCompass");a(this,"commandQueue",[]);const e=window;this.microadCompass=e.microadCompass||{},e.microadCompass=this.microadCompass}static getInstance(){return V.instance||(V.instance=new V),V.instance}initializeCommandQueue(){const e=this.microadCompass.cmd||[];Array.isArray(e)&&(this.appendHook(),e.forEach(t=>{this.commandQueue.push(t)}))}appendHook(){const e=[];e.push=t=>(typeof t=="function"&&t.call(null),e.length),this.microadCompass.cmd=e,this.commandQueue=e}};a(V,"instance",null);let xe=V;class wi{constructor(){a(this,"getGoogleTag",e=>{try{return e.parent.googletag}catch{return}})}getGpidSlot(e=window){const t=this.getGoogleTag(e);if(!t||!t.pubads)return;const i=this.getGoogleSlotId(e);if(i)return this.getGpidBySlotId(t,i)}getGoogleSlotId(e){const t=e.frameElement;if(!t)return;const i=t.parentNode;if(!i)return;const s=i.parentNode;if(s)return s.id}getGpidBySlotId(e,t){try{const i=e.pubads().getSlots().find(s=>s.getSlotElementId()===t);return i?{gpid:i.getAdUnitPath(),adservname:"gam",adservadslot:i.getAdUnitPath()}:void 0}catch{return}}}class Ci{constructor(e=new wi){this.gptSlotSelector=e}selectGpidSlot(e){return e&&e.gpid&&e.adservname&&e.adservadslot?e:this.gptSlotSelector.getGpidSlot()}}class I{constructor(){a(this,"microadCompass");const e=window;if(this.microadCompass=e.microadCompass||{},e.microadCompass=this.microadCompass,!this.microadCompass.ad){const t=new Kt(this);this.microadCompass.ad=new Bt(t.rendering.bind(t))}if(this.microadCompass.frequency||(this.microadCompass.frequency=new ai),this.microadCompass.adomains||(this.microadCompass.adomains=new ci),this.microadCompass.gpid||(this.microadCompass.gpid=new Ci),!this.microadCompass.loadAdNonIframeDisplay){const t=new zt(this);this.microadCompass.loadAdNonIframeDisplay=t.load.bind(t)}if(!this.microadCompass.displayExternalReward){const t=new Yt(this);this.microadCompass.displayExternalReward=t.rendering.bind(t)}if(this.microadCompass.adServiceSettings||(this.microadCompass.adServiceSettings=ge.getInstance()),!this.microadCompass.ResponseController||!this.microadCompass.ResponseController.callback){const t=new Zt(this.microadCompass,this);this.microadCompass.ResponseController={callback:t.callback.bind(t)}}if(!this.microadCompass.listenersAdapter){const t=new at;this.microadCompass.listenersAdapter=t.of.bind(t)}if(!this.microadCompass.displayOfferWall){const t=new ii(this);this.microadCompass.displayOfferWall=t.render.bind(t)}}static async create(){const e=new I;return await e.asyncInit(),e}async asyncInit(){const e=window,t=e.microadCompass||{};e.microadCompass=t,t.aids||(t.aids=[]),t.audience=t.audience||new pi(t),await t.audience.track(),await new Ei().track(t)}initializeQueues(){xe.getInstance().initializeCommandQueue(),this.microadCompass.AdInitializer().init()}selectDisplayFunc(){return this.microadCompass.ad.selectDisplayFunc()}selectTemplate(e){return this.microadCompass.ad.selectTemplate(e)}selectAudienceIds(){return this.microadCompass.aids||[]}selectClientHints(){return this.microadCompass.ch}addRequestBySpot(e){var s;const t=e.spot;if(t==null)return;const i=((s=this.microadCompass.spotRequests)==null?void 0:s[t])||[];i.push(e),this.microadCompass.spotRequests[t]=i}getAdRequestBySpot(e){const t=this.microadCompass.spotRequests[e];return(t==null?void 0:t[0])??{}}selectMicroadCompassFrequency(){return this.microadCompass.frequency}selectMicroadCompassAdomains(){return this.microadCompass.adomains}registerTemplateByImpression(e,t,i){this.microadCompass.ad.registerTemplateByImpression(e,t,i)}selectMicroadCompassOverridingHandler(){return this.microadCompass.overridingHandler}getMicroadCompassAdServiceSettings(){return this.microadCompass.adServiceSettings}selectMicroadCompassVideoAdPlayer(e){const{videoAdPlayers:t}=this.microadCompass;return t?t[e]:null}selectMicroadCompassGpid(){return this.microadCompass.gpid}}async function Ai(){(await I.create()).initializeQueues()}Ai();
})();
